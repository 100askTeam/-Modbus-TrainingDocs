<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Modbus-projectOne/chapter8" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">第7章 低成本 Modbus 传感器的实现 | 全场景工业互联</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://modbus.100ask.net/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://modbus.100ask.net/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://modbus.100ask.net/Modbus-projectOne/chapter8"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第7章 低成本 Modbus 传感器的实现 | 全场景工业互联"><meta data-rh="true" name="description" content="7.1 硬件资源介绍与接线"><meta data-rh="true" property="og:description" content="7.1 硬件资源介绍与接线"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://modbus.100ask.net/Modbus-projectOne/chapter8"><link data-rh="true" rel="alternate" href="https://modbus.100ask.net/Modbus-projectOne/chapter8" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://modbus.100ask.net/en/Modbus-projectOne/chapter8" hreflang="en"><link data-rh="true" rel="alternate" href="https://modbus.100ask.net/Modbus-projectOne/chapter8" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.e3ab61ce.css">
<script src="/assets/js/runtime~main.1b78832e.js" defer="defer"></script>
<script src="/assets/js/main.b43a9e0f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="DshanPI" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="DshanPI" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">工业互联</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Modbus-projectOne/chapter1">项目一</a><a class="navbar__item navbar__link" href="/Modbus-projectTwo/BoardIntroduction">项目二</a><a class="navbar__item navbar__link" href="/Modbus-projectThree/BoardIntroduction">项目三</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/Modbus-projectOne/chapter8" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li><li><a href="/en/Modbus-projectOne/chapter8" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li></ul></div><a href="https://github.com/100askTeam/Modbus-TrainingDocs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter1">第0章 项目方案介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter2">第1章 搭建开发环境</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter3">第2章 开发板使用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter4">第3章 UART 开发基础</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/第4章-usb-设备编程">第4章 USB 设备编程</a><button aria-label="展开侧边栏分类 &#x27;第4章 USB 设备编程&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/第5章-modbus通讯协议">第5章 Modbus通讯协议</a><button aria-label="展开侧边栏分类 &#x27;第5章 Modbus通讯协议&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter7">第6章 libmodbus使用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/Modbus-projectOne/chapter8">第7章 低成本 Modbus 传感器的实现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter9">第8章 程序升级</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter10">第9章 综合实现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter11">第10章 调试心得</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第7章 低成本 Modbus 传感器的实现</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>第7章 低成本 Modbus 传感器的实现</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="71-硬件资源介绍与接线">7.1 硬件资源介绍与接线<a href="#71-硬件资源介绍与接线" class="hash-link" aria-label="7.1 硬件资源介绍与接线的直接链接" title="7.1 硬件资源介绍与接线的直接链接">​</a></h2>
<p>我们的 Modbus 传感器开发套件共有三个， 三个板子的使用的主控方案是 STM32F030芯片，硬件接口资源如下图所示：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image1-17bb2f9cea9a7c53140b6aec6edf4bcc.png" width="960" height="700" class="img_ev3q"></p>
<p>开关量模块</p>
<p><img loading="lazy" alt="img" src="/assets/images/image2-e57de85889da7a1dae89d90c1f0fe413.png" width="768" height="614" class="img_ev3q"></p>
<p>温湿度变送器模块</p>
<p><img loading="lazy" alt="img" src="/assets/images/image3-6e301ec9d04e8d4473234e49a2f476f5.png" width="803" height="662" class="img_ev3q"></p>
<p>环境检测模块</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="72-开发环境搭建">7.2 开发环境搭建<a href="#72-开发环境搭建" class="hash-link" aria-label="7.2 开发环境搭建的直接链接" title="7.2 开发环境搭建的直接链接">​</a></h2>
<p>在前面我们已经安装了 Keil MDK、STM32CubeMX、STM32CubeProgrammer、ST-Link 驱 动、 CH340 驱动。因此在这里我们只需给 Keil MDK 安装 STM32F030 对应的 PACK 即可对改 芯片进行编码开发。</p>
<p>安装 PACK 的方法有两种：</p>
<ul>
<li>第一种方法：双击运行开发板配套资料中的 Pack 安装包，随后弹出安装界面，按照默 认选项进行安装即可。：</li>
</ul>
<p><img loading="lazy" alt="img" src="/assets/images/image4-bb4648ad33253457a858b8353961a77b.png" width="638" height="133" class="img_ev3q"></p>
<ul>
<li>第二种方法，在线安装， 下面演示如何在线安装。</li>
</ul>
<p>打开Keil之后， 点击如下按钮启动“Pack Installer”：</p>
<p><img loading="lazy" src="/assets/images/image5-87484d868a16ddc8914a24885ad0ee52.png" width="894" height="129" class="img_ev3q"></p>
<p>使用 “Pack Installer” 可 以 方 便 的 对 Pack 安 装 和 管 理 。 在 左 上 角 搜 索 框 输 入 “STM32F030”，展开搜索结果，可以看到STM32F030CC，点击右边的简介链接即可跳转 到Pack下载页面，如下图所示。</p>
<p><img loading="lazy" alt="img" src="/assets/images/image6-7b5ecd75215720222263db2cdaadbde6.png" width="1416" height="793" class="img_ev3q"></p>
<p>如果跳转网页无法打开，可直接打开 Pack 下载总入口（<a href="http://www.keil.com/dd2/Pack/%EF%BC%89%E3%80%82" target="_blank" rel="noopener noreferrer">www.keil.com/dd2/Pack/）。</a> 进入 Pack 下载总入口后，搜索“STM32F030”，找到“STM030CCT”点击, 如下图所示（实 测部分网络环境打开该链接无 Pack 列表，请尝试换个网络环境测试，仍旧不行则使用配 套资料 Pack）。</p>
<p><img loading="lazy" alt="img" src="/assets/images/image7-cd99f1977f4871f22c4fc5c67eeee9b9.png" width="1369" height="677" class="img_ev3q"></p>
<p>点击会跳转到 pack 包界面，点击右上角的”STM32F0xxDFP“即可跳转到 pack 包下载界面，点击右上角”STM32F0xxDFP“处即可下载 pack 包，如下图所示。</p>
<p><img loading="lazy" alt="img" src="/assets/images/image8-c6a59120aad22631aa2d05197c28d0a9.png" width="1363" height="402" class="img_ev3q"></p>
<p><img loading="lazy" alt="img" src="/assets/images/image9-b820e8493096342e22b08dfca22adedb.png" width="1381" height="298" class="img_ev3q"></p>
<p>下载完成得到“Keil.STM32F0xx_DFP.2.1.1.pack”，直接双击该文件，随后弹出安装界 面，按照默认选项进行安装即可。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="73-创建与体验第-1-个工程">7.3 创建与体验第 1 个工程<a href="#73-创建与体验第-1-个工程" class="hash-link" aria-label="7.3 创建与体验第 1 个工程的直接链接" title="7.3 创建与体验第 1 个工程的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="731-创建工程">7.3.1 创建工程<a href="#731-创建工程" class="hash-link" aria-label="7.3.1 创建工程的直接链接" title="7.3.1 创建工程的直接链接">​</a></h3>
<p>启动 STM32CubeMX 后，点击如下图标开始选择 MCU：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image10-fc2cd8ea895184207305aa6467614a59.png" width="1142" height="627" class="img_ev3q"></p>
<p>如下图输入型号“STM32F030CCT”，双击找到的芯片， 开始创建工程：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image11-929a4216a830947bfb8811e4812f7893.png" width="1135" height="728" class="img_ev3q"></p>
<p>调高 CPU 频率：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image12-7604d3618a9365990ccf84f98c2b1e26.png" width="1419" height="766" class="img_ev3q"></p>
<p>配置工程， 如下操作：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image13-80a37f6ec2ddd9b9d3713a0e2cf7c8f2.png" width="1412" height="759" class="img_ev3q"></p>
<p>指定代码生成方法， 如下：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image14-3a022284b58c22ace9bbc73b794d5bf3.png" width="1423" height="767" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="732-配置调试器">7.3.2 配置调试器<a href="#732-配置调试器" class="hash-link" aria-label="7.3.2 配置调试器的直接链接" title="7.3.2 配置调试器的直接链接">​</a></h3>
<p>新建的工程要配置调试器，参考<a href="#bookmark1">《2.2.3 配置调试器》 。</a></p>
<p>然后就可以编译程序、烧写运行了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="733-配置-gpio-操作-led">7.3.3 配置 GPIO 操作 LED<a href="#733-配置-gpio-操作-led" class="hash-link" aria-label="7.3.3 配置 GPIO 操作 LED的直接链接" title="7.3.3 配置 GPIO 操作 LED的直接链接">​</a></h3>
<p>打开位于“5_硬件资料\01_开发板原理图\STM32F030CCT6_SWITCH_V11.pdf”的原理图 文件。</p>
<p>根据开发板原理图可以看到 F030的LED 引脚图如下：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image15-528fbfb70bfc5eeb68fd35bb2fea5ff1.png" width="318" height="485" class="img_ev3q"></p>
<p>可以双击打开工程中如下文件进入STM32CubeMX进行配置：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image16-32391067ff49a030469ec4af5bb47411.png" width="261" height="204" class="img_ev3q"></p>
<p>然后如下配置 PB11 、PB12 、PB13 为输出引脚：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image17-ae37cf4cbc3fe1d7b2e908c139345ea3.png" width="1417" height="768" class="img_ev3q"></p>
<p>点击右上角的 “GENERATE CODE”按钮后打开工程。</p>
<p>在main函数的循环里， 增加如下代码：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* Infinite loop */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* USER CODE BEGIN WHILE */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* USER CODE END WHILE */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* USER CODE BEGIN 3 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* set LED output high */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_GPIO_WritePin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//LED1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_GPIO_WritePin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//LED2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_GPIO_WritePin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_13</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//LED3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_Delay</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* set LED output low */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_GPIO_WritePin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_RESET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token comment" style="color:#999988;font-style:italic">//LED1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_GPIO_WritePin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_RESET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//LED2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_GPIO_WritePin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">GPIOB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_13</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> GPIO_PIN_RESET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//LED3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_Delay</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后编译、烧写、运行， 可以看到开发板的 LED 闪烁。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="74-uart-编程">7.4 UART 编程<a href="#74-uart-编程" class="hash-link" aria-label="7.4 UART 编程的直接链接" title="7.4 UART 编程的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="741-使用-stm32cubemx-进行配置">7.4.1 使用 STM32CubeMX 进行配置<a href="#741-使用-stm32cubemx-进行配置" class="hash-link" aria-label="7.4.1 使用 STM32CubeMX 进行配置的直接链接" title="7.4.1 使用 STM32CubeMX 进行配置的直接链接">​</a></h3>
<p>本节源码为“3_程序源码\01_视频配套的源码\7-5_STM32F030串口编程\demo”。 RS4385接口原理图如下：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image18-1fea84134b5d8aa2fa6aa974cc094415.png" width="598" height="325" class="img_ev3q"></p>
<p>需要在STM32CubeMX里配置UART1，并且配置PA8为输出引脚。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1uart1">1.UART1<a href="#1uart1" class="hash-link" aria-label="1.UART1的直接链接" title="1.UART1的直接链接">​</a></h4>
<p>先使能 UART1：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image19-b52ff4072bd94899ef52c9d9fea8db5c.png" width="667" height="457" class="img_ev3q"></p>
<p>然后使能中断：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image20-4468bda8e3579f0ac96bdfb3e24abcab.png" width="693" height="137" class="img_ev3q"></p>
<p>在前面STM32H5的UART程序里使用了DMA，本节故意不使用DMA而使用纯中断来 实现UART，多学一种编程方法。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2配置-rs485方向引脚">2.配置 RS485方向引脚<a href="#2配置-rs485方向引脚" class="hash-link" aria-label="2.配置 RS485方向引脚的直接链接" title="2.配置 RS485方向引脚的直接链接">​</a></h4>
<p>STM32H5主控板上使用的RS485转换芯片是MAX13487EESA，它会自动切换发送、 接收方向，无需程序进行方向的控制。使用STM32F030制作的“廉价传感器”里，使用 的RS485转换芯片是SIT3088ETK，它需要使用一个GPIO来控制方向，如下图所示：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image21-6d125cb93ee4b64dad4c96ffd62ab413.png" width="693" height="209" class="img_ev3q"></p>
<p>上图中，RS485_CTRL使用的引脚是PA8，所以还需要把它配置为输出引脚，输出低 电平（让SIT3088ETK默认为接收状态） 。如下配置：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image22-c15a7b60d594fc9ecc75dbac6917a4e6.png" width="357" height="426" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="742-封装-uart">7.4.2 封装 UART<a href="#742-封装-uart" class="hash-link" aria-label="7.4.2 封装 UART的直接链接" title="7.4.2 封装 UART的直接链接">​</a></h3>
<p>本节源码为“3_程序源码\01_视频配套的源码\7-5_STM32F030串口编程\demo”。 现场编程。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="743-上机实验">7.4.3 上机实验<a href="#743-上机实验" class="hash-link" aria-label="7.4.3 上机实验的直接链接" title="7.4.3 上机实验的直接链接">​</a></h3>
<p>本节源码为“3_程序源码\01_视频配套的源码\7-6_STM32F030 串口测试”，里面有 2 个程序：h5_demo、f030_demo。</p>
<p>要测试 STM32F030 的串口， 只需要把它的 485 接口连接到 PC 去就可以了，但是我们没 有 PC 上使用的“USB 转 485”模块，所以使用 STM32H5 来实现一个“USB 转 485 模块”：</p>
<ul>
<li>
<p>它从 USB 串口读到数据，再从 485 接口发送出去；</p>
</li>
<li>
<p>它从 485 接口读到数据，再从 USB 串口发送给 PC。</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-硬件连接">1. 硬件连接<a href="#1-硬件连接" class="hash-link" aria-label="1. 硬件连接的直接链接" title="1. 硬件连接的直接链接">​</a></h4>
<p><img loading="lazy" alt="img" src="/assets/images/image23-5190562c9e89446465426fcd1287ef0a.png" width="669" height="451" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-stm32h5-程序改造">2. STM32H5 程序改造<a href="#2-stm32h5-程序改造" class="hash-link" aria-label="2. STM32H5 程序改造的直接链接" title="2. STM32H5 程序改造的直接链接">​</a></h4>
<p>本节源码为“3_程序源码\01_视频配套的源码\7-6_STM32F030串口测试\h5_demo”。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3stm32f030程序调试">3.STM32F030程序调试<a href="#3stm32f030程序调试" class="hash-link" aria-label="3.STM32F030程序调试的直接链接" title="3.STM32F030程序调试的直接链接">​</a></h4>
<p>本节源码为“3_程序源码\01_视频配套的源码\7-6_STM32F030串口测试\f030_demo”。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="75-libmodbus-移植">7.5 libmodbus 移植<a href="#75-libmodbus-移植" class="hash-link" aria-label="7.5 libmodbus 移植的直接链接" title="7.5 libmodbus 移植的直接链接">​</a></h2>
<p>本节源码为“3_ 程序源码\01_ 视频配套的源码\7-7_STM32F030 上libmodbus 移植 \f030_demo”。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="751-移植-libmodbus">7.5.1 移植 libmodbus<a href="#751-移植-libmodbus" class="hash-link" aria-label="7.5.1 移植 libmodbus的直接链接" title="7.5.1 移植 libmodbus的直接链接">​</a></h3>
<p>把“7-6_STM32F030串口测试\h5_demo\demo\Middlewares\Third_Party\libmodbus”整 个目录复制到f030_demo中。</p>
<p>在Keil工程中添加代码， 如下：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image24-f5aa9bf8b3c4c2e5e0fa15463d767353.png" width="418" height="405" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="752-使用-modbus-控制设备">7.5.2 使用 modbus 控制设备<a href="#752-使用-modbus-控制设备" class="hash-link" aria-label="7.5.2 使用 modbus 控制设备的直接链接" title="7.5.2 使用 modbus 控制设备的直接链接">​</a></h3>
<p>STM32F030作为从设备（sever），编写“Core\Src\freertos.c”：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="753-上机实验">7.5.3 上机实验<a href="#753-上机实验" class="hash-link" aria-label="7.5.3 上机实验的直接链接" title="7.5.3 上机实验的直接链接">​</a></h3>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="76-传感器设计">7.6 传感器设计<a href="#76-传感器设计" class="hash-link" aria-label="7.6 传感器设计的直接链接" title="7.6 传感器设计的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="761-设计思路">7.6.1 设计思路<a href="#761-设计思路" class="hash-link" aria-label="7.6.1 设计思路的直接链接" title="7.6.1 设计思路的直接链接">​</a></h3>
<p>上位机（PC 软件）或中控（STM32H5）通过 modbus 协议访问 STM32F030 传感器时，读 写的是 STM32F030 分配出来的 4 个类型的缓冲区。这里需要解决 2 个问题：</p>
<ul>
<li>
<p>这 4 个类型的缓冲区起始地址、大小分别是多少？ 这根据传感器的功能来设置。比如有 2 个按键，那么就可以分配 2 个“只读的位寄存器”（DI）。</p>
</li>
<li>
<p>这些寄存器的值， 如何跟硬件对应？ 比如上位机读 DI 寄存器时， 谁提供这些值？传感 器的程序应该读取按键值，填充 DI 寄存器。</p>
</li>
</ul>
<p>第 1 个步骤，被称为“点表设计”。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="762-三款传感器功能及所用引脚">7.6.2 三款传感器功能及所用引脚<a href="#762-三款传感器功能及所用引脚" class="hash-link" aria-label="7.6.2 三款传感器功能及所用引脚的直接链接" title="7.6.2 三款传感器功能及所用引脚的直接链接">​</a></h3>
<p>这 3 款传感器的原理图在网盘如下目录里：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image25-636446e9d0bd4b6a9967089aa9573be1.png" width="388" height="263" class="img_ev3q"></p>
<p>它们控制外设所用的引脚，列表如下：</p>
<table><thead><tr><th></th><th>功能</th><th>使用的引脚</th><th>描述</th><th>寄存器类别</th></tr></thead><tbody><tr><td>ENV_MONITOR 环境监测模块</td><td>BEEP1</td><td>PB15</td><td>高电平发声</td><td>DO</td></tr><tr><td></td><td>BEEP2</td><td>PB14</td><td>高电平发声</td><td>DO</td></tr><tr><td></td><td>LED1</td><td>PB11</td><td>低电平发光</td><td>DO</td></tr><tr><td></td><td>LED2</td><td>PB12</td><td>低电平发光</td><td>DO</td></tr><tr><td></td><td>LED3</td><td>PB13</td><td>低电平发光</td><td>DO</td></tr><tr><td></td><td>OPTO_ADC</td><td>PA1</td><td>电压值跟光强成反比</td><td>AI</td></tr><tr><td></td><td>RES_ADC</td><td>PA2</td><td>电压值跟可调电阻成反比</td><td>AI</td></tr><tr><td>SWITCH开关量模块</td><td>KEY1</td><td>PA3</td><td>低电平表示被按下</td><td>DI</td></tr><tr><td></td><td>KEY2</td><td>PA4</td><td>低电平表示被按下</td><td>DI</td></tr><tr><td></td><td>KEY3</td><td>PA5</td><td>低电平表示被按下</td><td>DI</td></tr><tr><td></td><td>K1_CTRL</td><td>PB5</td><td>高电平使能继电器</td><td>DO</td></tr><tr><td></td><td>K2_CTRL</td><td>PB4</td><td>高电平使能继电器</td><td>DO</td></tr><tr><td></td><td>LED1</td><td>PB11</td><td>低电平发光</td><td>DO</td></tr><tr><td></td><td>LED2</td><td>PB12</td><td>低电平发光</td><td>DO</td></tr><tr><td></td><td>LED3</td><td>PB13</td><td>低电平发光</td><td>DO</td></tr><tr><td>TEMP_HUMI温湿度模块</td><td>BEEP1</td><td>PB15</td><td>高电平发声</td><td>DO</td></tr><tr><td></td><td>BEEP2</td><td>PB14</td><td>高电平发声</td><td>DO</td></tr><tr><td></td><td>LED1</td><td>PB11</td><td>低电平发光</td><td>DO</td></tr><tr><td></td><td>LED2</td><td>PB12</td><td>低电平发光</td><td>DO</td></tr><tr><td></td><td>LED3</td><td>PB13</td><td>低电平发光</td><td>DO</td></tr><tr><td></td><td>I2C1_SCL</td><td>PB6</td><td>可以读到温度、湿度	AI</td><td>AI</td></tr><tr><td></td><td>I2C2_SDA</td><td>PB7</td><td>可以读到温度、湿度	AI</td><td>AI</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="763-点表设计">7.6.3 点表设计<a href="#763-点表设计" class="hash-link" aria-label="7.6.3 点表设计的直接链接" title="7.6.3 点表设计的直接链接">​</a></h3>
<p>所谓点表， 就是一个 modbus 设备，它的地址是什么？ 它里面 4 类寄存器的地址、功能 是什么。</p>
<p>在查看点表时，经常碰到“遥测、遥信、遥控、遥调”的概念。它们实质上就是前面 讲解 modbus 时引入的“AI、DI、DO、AO”。这些概念起源于电力系统。</p>
<p>电力领域中四遥系统是指遥测、遥信、遥控、遥调功能系统， 四遥功能是电力监控系 统最基本最重要的功能。具体来说：</p>
<ul>
<li>
<p>遥测(遥测信息，AI)：远程测量；远方测量显示诸如电流、电压、功率、压力、温度等 模拟量；</p>
</li>
<li>
<p>遥信(遥信信息，DI)：远程信号；远方监视各类电气开关和设备、机械设备的工作状态 和运转情况状态等；</p>
</li>
<li>
<p>遥控(遥控信息，DO)：远程控制；接受并执行遥控命令，远方控制或保护电气设备及电 气机械化的分合起停等工作状态；</p>
</li>
<li>
<p>遥调(遥调信息，AO)：远程调节；接受并执行遥调命令，远方设定及调整所控设备的工 作参数、标准参数；四遥遥测、遥信、遥控、遥调常常被简称为 AI、DI、DO、AO。</p>
</li>
</ul>
<p>AI、DI、DO、AO 都是英文名称的首字母缩写，A 的英文全称 Analog (模拟量)、D 的英 文全称 Digital (数字量) 、I 的英文全称 Input (输入)、O 的英文全称 Output (输出)。 因此, AI 表示的是模拟信号输出， AO 是模拟信号输入，DI 是数字信号输入， DO 是数字信 号输出。</p>
<p>随着技术不断地进步，现在也有五遥的说法， 即在四遥的基础上加上遥视， 遥视指的 是指利用包括电子技术、计算机技术、自动化技术等监视并记录  设备运行情况和环境安全 情况。因此伴随着技术发展， 电力系统中从一遥（遥信 DI）阶段、发展到二遥（遥信 AI、 遥测 DI）、三遥（遥信 AI、遥测 DI 和遥控 DO）、四遥（遥信 AI、遥测 DI、遥控 DO 和遥 调 AO）；现在开始四遥向五遥过渡。</p>
<p>原文链接：<a href="https://blog.csdn.net/LuohenYJ/article/details/106027626" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/LuohenYJ/article/details/106027626</a></p>
<p>在阅读点表时，还会碰到下表中的“PLC/组态地址”，或者表中的简称“0x、1x、4x、 3x”， 它们的本质都是用来分辨“AI、AO、DI、DO”四类寄存器：</p>
<table><thead><tr><th>寄存器种类</th><th>PLC/组态地址</th><th>Modbus 寄存器地址范围</th><th>简称</th><th>读写状态</th></tr></thead><tbody><tr><td>线圈状态</td><td>00001~09999</td><td>0000H~FFFFH</td><td>0x</td><td>可读可写</td></tr><tr><td>离散输入状态</td><td>~10001 19999</td><td>0000H~FFFFH</td><td>1x</td><td>只读</td></tr><tr><td>保持寄存器</td><td>40001~49999</td><td>0000H~FFFFH</td><td>4x</td><td>可读可写</td></tr><tr><td>输入寄存器</td><td>~30001 39999</td><td>0000H~FFFFH</td><td>3x</td><td>只读</td></tr></tbody></table>
<p>点表的设计，是完全由开发人员自行定义的。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1开关量模块switch">1.开关量模块（SWITCH）<a href="#1开关量模块switch" class="hash-link" aria-label="1.开关量模块（SWITCH）的直接链接" title="1.开关量模块（SWITCH）的直接链接">​</a></h4>
<p>寄存器说明：</p>
<table><thead><tr><th>设备地址</th><th>寄存器地址</th><th>寄存器类别</th><th>用途</th><th>描述</th></tr></thead><tbody><tr><td>01H</td><td>0000H</td><td>DI</td><td>读取按键 KEY1</td><td>1-被按下</td></tr><tr><td>0001H</td><td>DI</td><td>读取按键 KEY2</td><td>1-被按下</td><td></td></tr><tr><td>0002H</td><td>DI</td><td>读取按键 KEY3</td><td>1-被按下</td><td></td></tr><tr><td>0000H</td><td>DO</td><td>控制继电器 1</td><td>1-吸合</td><td></td></tr><tr><td>0001H</td><td>DO</td><td>控制继电器 2</td><td>1-吸合</td><td></td></tr><tr><td>0002H</td><td>DO</td><td>控制 LED1</td><td>1-亮</td><td></td></tr><tr><td>0003H</td><td>DO</td><td>控制 LED2</td><td>1-亮</td><td></td></tr><tr><td>0004H</td><td>DO</td><td>控制 LED3</td><td>1-亮</td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-环境监测模块env_monitor">2. 环境监测模块（ENV_MONITOR）<a href="#2-环境监测模块env_monitor" class="hash-link" aria-label="2. 环境监测模块（ENV_MONITOR）的直接链接" title="2. 环境监测模块（ENV_MONITOR）的直接链接">​</a></h4>
<p>寄存器说明：</p>
<table><thead><tr><th>设备地址</th><th>寄存器地址</th><th>寄存器类别</th><th>用途</th><th>描述</th></tr></thead><tbody><tr><td>02H</td><td>0000H</td><td>DO</td><td>控制蜂鸣器 1</td><td>1-响</td></tr><tr><td>0001H</td><td>DO</td><td>控制蜂鸣器 2</td><td>1-响</td><td></td></tr><tr><td>0002H</td><td>DO</td><td>控制 LED1</td><td>1-亮</td><td></td></tr><tr><td>0003H</td><td>DO</td><td>控制 LED2</td><td>1-亮</td><td></td></tr><tr><td>0004H</td><td>DO</td><td>控制 LED3</td><td>1-亮</td><td></td></tr><tr><td>0000H</td><td>AI</td><td>读取光敏电压</td><td>0xfff 对应 3.3V12 位精度</td><td></td></tr><tr><td>0001H</td><td>AI</td><td>可调电阻器电压</td><td>0xfff 对应 3.3V12 位精度</td><td></td></tr></tbody></table>
<ol start="3">
<li>温湿度模块（TEMP HUMI）</li>
</ol>
<table><thead><tr><th>设备地址</th><th>寄存器地址</th><th>寄存器类别</th><th>用途</th><th>描述</th></tr></thead><tbody><tr><td>03H</td><td>0000H</td><td>DO</td><td>控制蜂鸣器 1</td><td>1-响</td></tr><tr><td>0001H</td><td>DO</td><td>控制蜂鸣器 2</td><td>1-响</td><td></td></tr><tr><td>0002H</td><td>DO</td><td>控制 LED1</td><td>1-亮</td><td></td></tr><tr><td>0003H</td><td>DO</td><td>控制 LED2</td><td>1-亮</td><td></td></tr><tr><td>0004H</td><td>DO</td><td>控制 LED3</td><td>1-亮</td><td></td></tr><tr><td>0000H</td><td>AI</td><td>读取温度</td><td>单位 0.1 摄氏度 16 位有符号整数</td><td></td></tr><tr><td>0001H</td><td>AI</td><td>读取湿度</td><td>单位 0.1%RH16 位有符合整数</td><td></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="764-开关量传感器程序设计">7.6.4 开关量传感器程序设计<a href="#764-开关量传感器程序设计" class="hash-link" aria-label="7.6.4 开关量传感器程序设计的直接链接" title="7.6.4 开关量传感器程序设计的直接链接">​</a></h3>
<p>继电器原理图如下：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image26-99b9cb7e5c43e3c9efe962706f3a6b35.png" width="692" height="236" class="img_ev3q"></p>
<p>继电器对外的信号有 3 个：</p>
<ul>
<li>COM：公共端，通常是中间的触点， 与常开或常闭触点相连</li>
<li>NC（Normally Closed）： 常闭接口，继电器吸合前与 COM 连接， 吸合后悬空</li>
<li>NO（Normally Open）： 常开接口， 继电器吸合前悬空， 吸合后与 COM 连接</li>
</ul>
<p>开路即通路、断路，闭合指的是开关闭合，也就是说， 在没有任何上电之类的动作时， NC 和 COM 端相当于已经连通。</p>
<p>本节源码为“ 3_ 程 序源 码\01_ 视 频配套 的 源 码\7-9_ 开 关 量 传 感 器 程序 设 计 \f030_demo”。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="765-环境监测传感器程序设计">7.6.5 环境监测传感器程序设计<a href="#765-环境监测传感器程序设计" class="hash-link" aria-label="7.6.5 环境监测传感器程序设计的直接链接" title="7.6.5 环境监测传感器程序设计的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-硬件电路">1. 硬件电路<a href="#1-硬件电路" class="hash-link" aria-label="1. 硬件电路的直接链接" title="1. 硬件电路的直接链接">​</a></h4>
<p>光敏电路如下， 光照越强，U6 阻值越低，OPTO_ADC 电压值就越低：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image27-f3a33d072ed9920a6e69f319b4cbac92.png" width="365" height="427" class="img_ev3q"></p>
<p>可调电阻器如下，R33 阻值越大，RES_ADC 电压值越小：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image28-ff3c2b81e8bbb541771760300c249f9b.png" width="302" height="339" class="img_ev3q"></p>
<p>本节源码为“3_ 程序源码\01_ 视频配套的源码\7-10_ 环境监测传感器程序设计 \f030_demo”。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-配置-gpio-和-adc">2. 配置 GPIO 和 ADC<a href="#2-配置-gpio-和-adc" class="hash-link" aria-label="2. 配置 GPIO 和 ADC的直接链接" title="2. 配置 GPIO 和 ADC的直接链接">​</a></h4>
<p>先在STM32CubmeMX里配置GPIO和ADC 引脚，使能“Discontinuous Conversion Mode ”：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image29-081e2eb72aa3079c6f1434b8c9566d30.png" width="693" height="353" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-读取-adc-的关键代码">3. 读取 ADC 的关键代码<a href="#3-读取-adc-的关键代码" class="hash-link" aria-label="3. 读取 ADC 的关键代码的直接链接" title="3. 读取 ADC 的关键代码的直接链接">​</a></h4>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 1. 检验</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">HAL_ADCEx_Calibration_Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">hadc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 启动、读2次数值</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">HAL_ADC_Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">hadc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">HAL_OK </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HAL_ADC_PollForConversion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">hadc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    	mb_mapping</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">tab_input_registers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HAL_ADC_GetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">hadc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="766-温湿度传感器程序设计">7.6.6 温湿度传感器程序设计<a href="#766-温湿度传感器程序设计" class="hash-link" aria-label="7.6.6 温湿度传感器程序设计的直接链接" title="7.6.6 温湿度传感器程序设计的直接链接">​</a></h3>
<p>本节源码为“ 3_ 程序源码\01_ 视频配套 的源码\7-11_ 温湿度传感器程序设计 \f030_demo”。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-硬件电路与操作方法">1. 硬件电路与操作方法<a href="#1-硬件电路与操作方法" class="hash-link" aria-label="1. 硬件电路与操作方法的直接链接" title="1. 硬件电路与操作方法的直接链接">​</a></h4>
<p> 原理图如下：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image30-0f4ef5a034cb81f7c4d6d89b21d48b4a.png" width="584" height="309" class="img_ev3q"></p>
<p>AHT20 芯片资料在网盘如下目录：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image31-8412848e07369cf1cdcfb080b2e8ca15.png" width="369" height="122" class="img_ev3q"></p>
<p>AHT20 操作方法如下：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image32-2c431cef26704e749f1f53c838650550.png" width="646" height="376" class="img_ev3q"></p>
<p>详解如下：</p>
<ul>
<li>发送测量命令：传感器的 VDD 上电后需等待 5ms， 发送写测量命令 0x70 0xAC 0x330x00， 等待 80ms 测量完成；</li>
<li>获取温湿度校准数据： 在等待 80ms 测量完成后， 发送 0x71 读传感器，可获取状态字 Status、温湿度校准数据 SRH[19:0]、ST[19:0]以及校准字 CRC；</li>
<li>根据公式计算温湿度：</li>
</ul>
<p><img loading="lazy" alt="img" src="/assets/images/image33-8c4d40a3b0dcfa731d6ad9c218b3d4ef.png" width="456" height="150" class="img_ev3q"></p>
<p>计算检验码的函数如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//**********************************************************//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//CRC校验类型：  CRC8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//多项式：  X8+X5+X4+1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//Poly:0011 0001 0x31</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Calc_CRC8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> Num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> byte</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> crc </span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0xFF</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">byte </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">byte</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Num</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">byte</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        crc</span><span class="token operator" style="color:#393A34">^=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">byte</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">i</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token operator" style="color:#393A34">--</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">crc</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token number" style="color:#36acaa">0x80</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            crc</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">crc</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">^</span><span class="token number" style="color:#36acaa">0x31</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            crc</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">crc</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> crc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token comment" style="color:#999988;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token comment" style="color:#999988;font-style:italic">//</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-配置-i2c">2. 配置 I2C<a href="#2-配置-i2c" class="hash-link" aria-label="2. 配置 I2C的直接链接" title="2. 配置 I2C的直接链接">​</a></h4>
<p><img loading="lazy" alt="img" src="/assets/images/image34-bd14fe601e339ffde73fcc83e7579108.png" width="873" height="352" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-读取温湿度关键代码">3. 读取温湿度关键代码<a href="#3-读取温湿度关键代码" class="hash-link" aria-label="3. 读取温湿度关键代码的直接链接" title="3. 读取温湿度关键代码的直接链接">​</a></h4>
<p>读取一次温湿度值， 耗时至少 80ms。不可能在接收到modbus 请求后再去读温湿度。而 是使用另一个任务不断读取温湿度。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HAL_StatusTypeDef </span><span class="token function" style="color:#d73a49">HAL_I2C_Master_Transmit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">I2C_HandleTypeDef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">hi2c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint16_t</span><span class="token plain"> DevAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint16_t</span><span class="token plain"> Size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> Timeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HAL_StatusTypeDef </span><span class="token function" style="color:#d73a49">HAL_I2C_Master_Receive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">I2C_HandleTypeDef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">hi2c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint16_t</span><span class="token plain"> DevAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint16_t</span><span class="token plain"> Size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> Timeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="77-访问多个传感器">7.7 访问多个传感器<a href="#77-访问多个传感器" class="hash-link" aria-label="7.7 访问多个传感器的直接链接" title="7.7 访问多个传感器的直接链接">​</a></h2>
<p>如下图连线，H5控制板使用USB线供电，中间的HUB也使用USB供电：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image35-5ecaf830a5f354a2a282eba4385fcaf9.png" width="554" height="219" class="img_ev3q"></p>
<p>连接示意图为：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image36-2163290712cc36319ce66059a599923a.png" width="554" height="210" class="img_ev3q"></p>
<p><strong>注意</strong>：三个传感器的启动开关都拨到“ON”位置。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="771-主控访问多个传感器">7.7.1 主控访问多个传感器<a href="#771-主控访问多个传感器" class="hash-link" aria-label="7.7.1 主控访问多个传感器的直接链接" title="7.7.1 主控访问多个传感器的直接链接">​</a></h3>
<p>本节源码为“3_程序源码\01_视频配套的源码\7-12_主控访问多个传感器\h5_demo、f030_demo”。</p>
<p>注意：f030_demo需要分别设置下面的宏（这3个宏同一时间只能定义一个），编译出程序后分别烧写到3个传感器里。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_SWITCH_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_ENV_MONITOR_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_TMP_HUMI_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>编写H5主控程序，为每个485通道创建一个任务，任务里创建modbus结构体：</p>
<ul>
<li>任务1：使用CH1，访问开关量传感器、环境监测传感器，在LCD上显示数据</li>
<li>任务2：使用CH2，访问温湿度传感器，在LCD上显示数据</li>
</ul>
<p>注意：因为任务1、任务2都访问LCD，在LCD函数里要加入互斥措施，否则LCD会花屏。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="772-上位机访问多个传感器">7.7.2 上位机访问多个传感器<a href="#772-上位机访问多个传感器" class="hash-link" aria-label="7.7.2 上位机访问多个传感器的直接链接" title="7.7.2 上位机访问多个传感器的直接链接">​</a></h3>
<p>本节源码为“3_程序源码\01_视频配套的源码\7-13 上位机访问多个传感器\h5_demo、f030_demo”。</p>
<p>注意：f030_demo需要分别设置下面的宏（这3个宏同一时间只能定义一个），编译出程序后分别烧写到3个传感器里。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_SWITCH_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_ENV_MONITOR_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_TMP_HUMI_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在上位机的角度，它只看到H5主控板一个Modbus设备。上位机怎么去访问接在H5上的其他3个传感器？这里需要进行“映射”：上位机读写H5的某个寄存器，其实是去读写某个传感器。</p>
<p>本节使用一个固定的映射点表，如下：</p>
<table><thead><tr><th>H5设备地址</th><th>H5寄存器地址</th><th>H5寄存器类别</th><th>映射</th><th>用途</th><th>描述</th></tr></thead><tbody><tr><td>01H</td><td>0000H</td><td>DI</td><td>CH1ID=1DI寄存器0</td><td>读取开关量传感器的按键KEY1</td><td>1-被按下</td></tr><tr><td>0001H</td><td>DI</td><td>CH1ID=1DI寄存器1</td><td>读取开关量传感器的按键KEY2</td><td>1-被按下</td><td></td></tr><tr><td>0002H</td><td>DI</td><td>CH1ID=1DI寄存器2</td><td>读取开关量传感器的按键KEY3</td><td>1-被按下</td><td></td></tr><tr><td>0000H</td><td>DO</td><td>H5的LED</td><td>控制H5的LED</td><td>1-亮</td><td></td></tr><tr><td>0001H</td><td>DO</td><td>CH1ID=1DO寄存器0</td><td>控制开关量传感器的继电器1</td><td>1-吸合</td><td></td></tr><tr><td>0002H</td><td>DO</td><td>CH1ID=1DO寄存器1</td><td>控制开关量传感器的继电器2</td><td>1-吸合</td><td></td></tr><tr><td>0003H</td><td>DO</td><td>CH1ID=1DO寄存器2</td><td>控制开关量传感器的LED1</td><td>1-亮</td><td></td></tr><tr><td>0004H</td><td>DO</td><td>CH1ID=1DO寄存器3</td><td>控制开关量传感器的LED2</td><td>1-亮</td><td></td></tr><tr><td>0005H</td><td>DO</td><td>CH1ID=1DO寄存器4</td><td>控制开关量传感器的LED3</td><td>1-亮</td><td></td></tr><tr><td>0006H</td><td>DO</td><td>CH1ID=2DO寄存器0</td><td>控制 环境监测传感器的蜂鸣器1</td><td>1-响</td><td></td></tr><tr><td>0007H</td><td>DO</td><td>CH1ID=2DO寄存器1</td><td>控制环境监测传感器的蜂鸣器2</td><td>1-响</td><td></td></tr><tr><td>0008H</td><td>DO</td><td>CH1ID=2DO寄存器2</td><td>控制环境监测传感器的LED1</td><td>1-亮</td><td></td></tr><tr><td>0009H</td><td>DO</td><td>CH1ID=2DO寄存器3</td><td>控制环境监测传感器的LED2</td><td>1-亮</td><td></td></tr><tr><td>000AH</td><td>DO</td><td>CH1ID=2DO寄存器4</td><td>控制环境监测传感器的LED3</td><td>1-亮</td><td></td></tr><tr><td>000BH</td><td>DO</td><td>CH2ID=3DO寄存器0</td><td>控制温湿度传感器的蜂鸣器1</td><td>1-响</td><td></td></tr><tr><td>000CH</td><td>DO</td><td>CH2ID=3DO寄存器1</td><td>控制温湿度传感器的蜂鸣器2</td><td>1-响</td><td></td></tr><tr><td>000DH</td><td>DO</td><td>CH2ID=3DO寄存器2</td><td>控制温湿度传感器的LED1</td><td>1-亮</td><td></td></tr><tr><td>000EH</td><td>DO</td><td>CH2ID=3DO寄存器3</td><td>控制温湿度传感器的LED2</td><td>1-亮</td><td></td></tr><tr><td>000FH</td><td>DO</td><td>CH2ID=3DO寄存器4</td><td>控制温湿度传感器的LED3</td><td>1-亮</td><td></td></tr><tr><td>0000H</td><td>AI</td><td>CH1ID=2AI寄存器0</td><td>读取环境监测传感器的光敏电压</td><td>0xfff对应3.3V12位精度</td><td></td></tr><tr><td>0001H</td><td>AI</td><td>CH1ID=2AI寄存器1</td><td>读取环境监测传感器的可调电阻器电压</td><td>0xfff对应3.3V12位精度</td><td></td></tr><tr><td>0002H</td><td>AI</td><td>CH2ID=3AI寄存器0</td><td>读取温湿度传感器的温度</td><td>单位0.1摄氏度16位有符号整数</td><td></td></tr><tr><td>0003H</td><td>AI</td><td>CH2ID=3AI寄存器1</td><td>读取温湿度传感器的湿度</td><td>单位0.1%RH16位有符合整数</td><td></td></tr></tbody></table>
<p>编写H5主控程序：</p>
<ul>
<li>任务1：创建一个Modbus设备，分配modbus_mapping_t，读取PC发来的请求并进行回应</li>
<li>任务2：使用CH1访问开关量传感器（ID=1），在modbus_mapping_t和传感器之间传递数据。</li>
<li>任务3：使用CH1访问环境监测传感器（ID=2），在modbus_mapping_t和传感器之间传递数据。</li>
<li>任务4：使用CH2访问温湿度传感器（ID=3），在modbus_mapping_t和传感器之间传递数据。</li>
</ul>
<p>程序框图如下图所示：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image37-03fdd5a9cd971c9da54a82eb19a02e15.png" width="554" height="382" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="78-程序改进">7.8 程序改进<a href="#78-程序改进" class="hash-link" aria-label="7.8 程序改进的直接链接" title="7.8 程序改进的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="781-主控uart代码的更好封装">7.8.1 主控UART代码的更好封装<a href="#781-主控uart代码的更好封装" class="hash-link" aria-label="7.8.1 主控UART代码的更好封装的直接链接" title="7.8.1 主控UART代码的更好封装的直接链接">​</a></h3>
<p>本节源码为“3_程序源码\01_视频配套的源码\7-14_主控UART代码的更好封装\h5_demo、f030_demo”。</p>
<p>对于同一款芯片上面的多个UART，它们的操作代码是类似的，没有必要为各个UART单独提供函数，如下代码有改进空间：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">UART_Device</span><span class="token plain"> g_uart2_dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;uart2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART2_Rx_Start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART2_Send</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART2_GetData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART2_Flush</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">UART_Device</span><span class="token plain"> g_uart4_dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;uart4&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART4_Rx_Start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART4_Send</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART4_GetData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART4_Flush</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以UART2_Rx_Start、UART4_Rx_Start为例，它们的代码如下：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image38-0742c8dc9fe747856b10d14575e11457.png" width="554" height="121" class="img_ev3q"></p>
<p><img loading="lazy" alt="img" src="/assets/images/image39-028044ce456b483eeb9ec3e74aa124e8.png" width="554" height="119" class="img_ev3q"></p>
<p>它们的功能是类似的，可以使用同一套函数UART_Rx_Start，关键是：</p>
<ul>
<li>如何分辨它要操作哪个UART？只能在第1个参数里进行分辨</li>
<li>如何记录创建的队列、信号量？最好存在第1个参数里</li>
</ul>
<p>所以，需要对UART_Device结构体进行扩展，添加“私有数据”，如下：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">UART_Device</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Init</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">UART_Device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pDev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> baud</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> parity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> data_bit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> stop_bit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Send</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">UART_Device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pDev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">datas</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain"> len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RecvByte</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">UART_Device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pDev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Flush</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">UART_Device</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pDev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">priv_data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">UART_Device</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PUART_Device</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述“priv_data”将指向设备相关的结构体，比如：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">RX_BUF_LEN</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">UART_Data</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      UART_HandleTypeDef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">huart</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      SemaphoreHandle_t txSemaphore</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      QueueHandle_t rxQueue</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">uint8_t</span><span class="token plain"> rx_buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">RX_BUF_LEN</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">UART_Data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PUART_Data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">UART_Data</span><span class="token plain"> g_uart1_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">huart1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">UART_Data</span><span class="token plain"> g_uart2_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">huart2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">UART_Data</span><span class="token plain"> g_uart4_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">huart4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后，就可以如此实现函数了：</p>
<div class="language-C language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">UART_Device g_uart1_dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;uart1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_Rx_Start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_Send</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_GetData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_Flush</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">g_uart1_data</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UART_Device g_uart2_dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;uart2&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_Rx_Start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_Send</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_GetData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_Flush</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">g_uart2_data</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UART_Device g_uart4_dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;uart4&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_Rx_Start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_Send</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_GetData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_Flush</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">g_uart4_data</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">UART_Rx_Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PUART_Device pDev</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> baud</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> parity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> data_bit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> stop_bit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PUART_Data data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pDev</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">priv_data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rxQueue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rxQueue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xQueueCreate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">txSemaphore </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">xSemaphoreCreateBinary</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">HAL_UARTEx_ReceiveToIdle_DMA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">huart</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rx_buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RX_BUF_LEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">//HAL_UARTEx_ReceiveToIdle_IT(data-&gt;huart, data-&gt;rx_buf, 1);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="782-增加容错代码">7.8.2 增加容错代码<a href="#782-增加容错代码" class="hash-link" aria-label="7.8.2 增加容错代码的直接链接" title="7.8.2 增加容错代码的直接链接">​</a></h3>
<p>本节源码为“3_程序源码\01_视频配套的源码\7-15_增加容错代码\h5_demo、f030_demo”。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-添加uart错误恢复代码"><strong>1. 添加UART错误恢复代码</strong><a href="#1-添加uart错误恢复代码" class="hash-link" aria-label="1-添加uart错误恢复代码的直接链接" title="1-添加uart错误恢复代码的直接链接">​</a></h4>
<p>无论是主控程序还是传感器程序，使用UART进行数据传输是本项目的关键。如果发生了UART错误，应该能从错误中恢复。</p>
<p>在错误中断回调函数里，重新初始化UART、重新启动数据接收，代码如下：</p>
<div class="language-C language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HAL_UART_ErrorCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UART_HandleTypeDef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">huart</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      PUART_Data data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">huart </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">huart1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">g_uart1_data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">huart </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">huart2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">g_uart2_data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">huart </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">huart4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">g_uart4_data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">HAL_UART_DeInit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">huart</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">HAL_UART_Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">huart</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* re-start DMA+IDLE rx */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">HAL_UARTEx_ReceiveToIdle_DMA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">huart</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rx_buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RX_BUF_LEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//HAL_UARTEx_ReceiveToIdle_IT(data-&gt;huart, data-&gt;rx_buf, 1);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-调整libmodbus的超时时间"><strong>2. 调整libmodbus的超时时间</strong><a href="#2-调整libmodbus的超时时间" class="hash-link" aria-label="2-调整libmodbus的超时时间的直接链接" title="2-调整libmodbus的超时时间的直接链接">​</a></h4>
<p>如下修改“Middlewares\Third_Party\libmodbus\modbus-private.h”：</p>
<div class="language-C language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">_RESPONSE_TIMEOUT</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">10000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">_BYTE_TIMEOUT</span><span class="token macro property" style="color:#36acaa">   </span><span class="token macro property expression number" style="color:#36acaa">10000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-主控发出libmodbus请求的间隔加大"><strong>3. 主控发出libmodbus请求的间隔加大</strong><a href="#3-主控发出libmodbus请求的间隔加大" class="hash-link" aria-label="3-主控发出libmodbus请求的间隔加大的直接链接" title="3-主控发出libmodbus请求的间隔加大的直接链接">​</a></h4>
<p>获得锁之后，等待一会再发送Modbus请求，以便让从机超时退出并进入新一轮的等待：</p>
<p><img loading="lazy" alt="img" src="/assets/images/image40-69773e8ebc9bf29051428d4898abc8e0.png" width="531" height="389" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/100askTeam/Modbus-TrainingDocs/tree/main/docs/Modbus-projectOne/chapter8.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/Modbus-projectOne/chapter7"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">第6章 libmodbus使用</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Modbus-projectOne/chapter9"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">第8章 程序升级</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#71-硬件资源介绍与接线" class="table-of-contents__link toc-highlight">7.1 硬件资源介绍与接线</a></li><li><a href="#72-开发环境搭建" class="table-of-contents__link toc-highlight">7.2 开发环境搭建</a></li><li><a href="#73-创建与体验第-1-个工程" class="table-of-contents__link toc-highlight">7.3 创建与体验第 1 个工程</a><ul><li><a href="#731-创建工程" class="table-of-contents__link toc-highlight">7.3.1 创建工程</a></li><li><a href="#732-配置调试器" class="table-of-contents__link toc-highlight">7.3.2 配置调试器</a></li><li><a href="#733-配置-gpio-操作-led" class="table-of-contents__link toc-highlight">7.3.3 配置 GPIO 操作 LED</a></li></ul></li><li><a href="#74-uart-编程" class="table-of-contents__link toc-highlight">7.4 UART 编程</a><ul><li><a href="#741-使用-stm32cubemx-进行配置" class="table-of-contents__link toc-highlight">7.4.1 使用 STM32CubeMX 进行配置</a></li><li><a href="#742-封装-uart" class="table-of-contents__link toc-highlight">7.4.2 封装 UART</a></li><li><a href="#743-上机实验" class="table-of-contents__link toc-highlight">7.4.3 上机实验</a></li></ul></li><li><a href="#75-libmodbus-移植" class="table-of-contents__link toc-highlight">7.5 libmodbus 移植</a><ul><li><a href="#751-移植-libmodbus" class="table-of-contents__link toc-highlight">7.5.1 移植 libmodbus</a></li><li><a href="#752-使用-modbus-控制设备" class="table-of-contents__link toc-highlight">7.5.2 使用 modbus 控制设备</a></li><li><a href="#753-上机实验" class="table-of-contents__link toc-highlight">7.5.3 上机实验</a></li></ul></li><li><a href="#76-传感器设计" class="table-of-contents__link toc-highlight">7.6 传感器设计</a><ul><li><a href="#761-设计思路" class="table-of-contents__link toc-highlight">7.6.1 设计思路</a></li><li><a href="#762-三款传感器功能及所用引脚" class="table-of-contents__link toc-highlight">7.6.2 三款传感器功能及所用引脚</a></li><li><a href="#763-点表设计" class="table-of-contents__link toc-highlight">7.6.3 点表设计</a></li><li><a href="#764-开关量传感器程序  设计" class="table-of-contents__link toc-highlight">7.6.4 开关量传感器程序设计</a></li><li><a href="#765-环境监测传感器程序设计" class="table-of-contents__link toc-highlight">7.6.5 环境监测传感器程序设计</a></li><li><a href="#766-温湿度传感器程序设计" class="table-of-contents__link toc-highlight">7.6.6 温湿度传感器程序设计</a></li></ul></li><li><a href="#77-访问多个传感器" class="table-of-contents__link toc-highlight">7.7 访问多个传感器</a><ul><li><a href="#771-主控访问多个传感器" class="table-of-contents__link toc-highlight">7.7.1 主控访问多个传感器</a></li><li><a href="#772-上位机访问多个传感器" class="table-of-contents__link toc-highlight">7.7.2 上位机访问多个传感器</a></li></ul></li><li><a href="#78-程序改进" class="table-of-contents__link toc-highlight">7.8 程序改进</a><ul><li><a href="#781-主控uart代码的更好封装" class="table-of-contents__link toc-highlight">7.8.1 主控UART代码的更好封装</a></li><li><a href="#782-增加容错代码" class="table-of-contents__link toc-highlight">7.8.2 增加容错代码</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://dongshanpi.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">DongshanPI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://canaan-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Canaan-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://renesas-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Renesas-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://rtos.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RTOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tina.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TinaSDK-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://allwinner-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Allwinner-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://aw-r128.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">R128-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/275908810" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.100ask.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://video.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VideoCenter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dongshanpi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weidongshan.coding.net/public/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/100askTeam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/weidongshan" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 100askTeam, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>