<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Modbus-projectOne/chapter10" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">第9章 综合实现 | 全场景工业互联</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://modbus.100ask.net/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://modbus.100ask.net/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://modbus.100ask.net/Modbus-projectOne/chapter10"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="第9章 综合实现 | 全场景工业互联"><meta data-rh="true" name="description" content="本章课程将根据上位机的接口规范，编写主控、传感器的综合程序：让上位机能读写传感器、升级主控程序、升级传感器程序。"><meta data-rh="true" property="og:description" content="本章课程将根据上位机的接口规范，编写主控、传感器的综合程序：让上位机能读写传感器、升级主控程序、升级传感器程序。"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://modbus.100ask.net/Modbus-projectOne/chapter10"><link data-rh="true" rel="alternate" href="https://modbus.100ask.net/Modbus-projectOne/chapter10" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://modbus.100ask.net/en/Modbus-projectOne/chapter10" hreflang="en"><link data-rh="true" rel="alternate" href="https://modbus.100ask.net/Modbus-projectOne/chapter10" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.e3ab61ce.css">
<script src="/assets/js/runtime~main.a543561f.js" defer="defer"></script>
<script src="/assets/js/main.352f64d2.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="DshanPI" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="DshanPI" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">工业互联</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/Modbus-projectOne/chapter1">项目一</a><a class="navbar__item navbar__link" href="/Modbus-projectTwo/BoardIntroduction">项目二</a><a class="navbar__item navbar__link" href="/Modbus-projectThree/BoardIntroduction">项目三</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>简体中文</a><ul class="dropdown__menu"><li><a href="/Modbus-projectOne/chapter10" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-Hans">简体中文</a></li><li><a href="/en/Modbus-projectOne/chapter10" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en">English</a></li></ul></div><a href="https://github.com/100askTeam/Modbus-TrainingDocs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter1">第0章 项目方案介绍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter2">第1章 搭建开发环境</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter3">第2章 开发板使用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter4">第3章 UART 开发基础</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/第4章-usb-设备编程">第4章 USB 设备编程</a><button aria-label="展开侧边栏分类 &#x27;第4章 USB 设备编程&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/category/第5章-modbus通讯协议">第5章 Modbus通讯协议</a><button aria-label="展开侧边栏分类 &#x27;第5章 Modbus通讯协议&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter7">第6章 libmodbus使用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter8">第7章 低成本 Modbus 传感器的实现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter9">第8章 程序升级</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/Modbus-projectOne/chapter10">第9章 综合实现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter11">第10章 调试心得</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/Modbus-projectOne/chapter12">第11章 简历模板</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">第9章 综合实现</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>第9章 综合实现</h1>
<p>本章课程将根据上位机的接口规范，编写主控、传感器的综合程序：让上位机能读写传感器、升级主控程序、升级传感器程序。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="91-产品框架">9.1 产品框架<a href="#91-产品框架" class="hash-link" aria-label="9.1 产品框架的直接链接" title="9.1 产品框架的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="911-硬件框架">9.1.1 硬件框架<a href="#911-硬件框架" class="hash-link" aria-label="9.1.1 硬件框架的直接链接" title="9.1.1 硬件框架的直接链接">​</a></h3>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image1.png" alt="img" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="912-设计思路">9.1.2 设计思路<a href="#912-设计思路" class="hash-link" aria-label="9.1.2 设计思路的直接链接" title="9.1.2 设计思路的 直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-上位机如何定位到传感器"><strong>1. 上位机如何定位到传感器</strong><a href="#1-上位机如何定位到传感器" class="hash-link" aria-label="1-上位机如何定位到传感器的直接链接" title="1-上位机如何定位到传感器的直接链接">​</a></h4>
<p>站在上位机的角度，以“Modbus传感器2为例”，上位机需要通过com1、channel1发出Modbus数据包，数据包里含有“设备地址”、“寄存器类别”、“寄存器地址”。所以，上位机需要确定这几个参数：</p>
<ul>
<li>串口：com1还是com2，或其他</li>
<li>通道：channel1还是channel2？可以使用channel0表示连接在主控上的设备</li>
<li>Modbus设备地址</li>
<li>Modbus设备的寄存器类别</li>
<li>Modbus设备的寄存器地址</li>
</ul>
<p>所以：在上位机的操作界面，增加一个“点”时，需要指定这5个参数。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-上位机如何读写传感器"><strong>2. 上位机如何读写传感器</strong><a href="#2-上位机如何读写传感器" class="hash-link" aria-label="2-上位机如何读写传感器的直接链接" title="2-上位机如何读写传感器的直接链接">​</a></h4>
<p>为了简化上位机的实现，在上位机的角度，它“只看到”一个传感器：就是主控。上位机读写主控的寄存器时，主控会去读写其他传感器。这有一个“映射”：主控的寄存器，映射到channel0、1、2的其他设备的某个寄存器。当上位机增加“点”时，上位机会得到用户设置的“5个参数”，它会利用这些参数创建映射关系，并且发给中控。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-中控如何读写传感器"><strong>3. 中控如何读写传感器</strong><a href="#3-中控如何读写传感器" class="hash-link" aria-label="3-中控如何读写传感器的直接链接" title="3-中控如何读写 传感器的直接链接">​</a></h4>
<p>中控程序得到上位机发来的“映射”信息后：</p>
<ul>
<li>读操作：中控不断地读取传感器的某个点的数值，以备上位机读取。</li>
<li>写操作：中控等待上位机发来的写命令，根据这些写命令去写传感器。</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-上位机如何发送映射关系传输固件"><strong>4. 上位机如何发送映射关系、传输固件</strong><a href="#4-上位机如何发送映射关系传输固件" class="hash-link" aria-label="4-上位机如何发送映射关系传输固件的直接链接" title="4-上位机如何发送映射关系传输固件的直接链接">​</a></h4>
<p>Modbus里有“Write File Record”功能，可以使用它来发送大量数据、发送文件。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-上位机界面"><strong>5. 上位机界面</strong><a href="#5-上位机界面" class="hash-link" aria-label="5-上位机界面的直接链接" title="5-上位机界面的直接链接">​</a></h4>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image2.png" alt="img" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="913-软件框架">9.1.3 软件框架<a href="#913-软件框架" class="hash-link" aria-label="9.1.3 软件框架的直接链接" title="9.1.3 软件框架的直接链接">​</a></h3>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image3.png" alt="img" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="92-改造libmodbus实现文件传输">9.2 改造libmodbus实现文件传输<a href="#92-改造libmodbus实现文件传输" class="hash-link" aria-label="9.2 改造libmodbus实现文件传输的直接链接" title="9.2 改造libmodbus实现文件传输的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="921-分析write-file-record功能">9.2.1 分析Write File Record功能<a href="#921-分析write-file-record功能" class="hash-link" aria-label="9.2.1 分析Write File Record功能的直接链接" title="9.2.1 分析Write File Record功能的直接链接">​</a></h3>
<p>想想这个场景，你要发出多个文件，每个文件还都很大，那么必然就是分块发送：</p>
<ul>
<li>当前发送的是哪个文件？数据包里有“File Number”</li>
<li>当前发送的是第几个数据包？数据包里有“Record Number”</li>
<li>当前发送的数据包多大？数据包里有“Record length”</li>
<li>数据本身</li>
</ul>
<p>“Write File Record”的请求格式如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image4.png" alt="img" class="img_ev3q"></p>
<p>“Write File Record”的回应跟请求包一模一样。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="922-实现write-file-record">9.2.2 实现Write File Record<a href="#922-实现write-file-record" class="hash-link" aria-label="9.2.2 实现Write File Record的直接链接" title="9.2.2 实现Write File Record的直接链接">​</a></h3>
<p>本节源码为“3_程序源码\01_视频配套的源码\ 9-2-2_实现Write_File_Record\h5_write_file_record”。</p>
<p>本节程序，在“3_程序源码\01_视频配套的源码\7-15_增加容错代码\h5_demo.7z”d的基础上修改而来。</p>
<p>本节要实现2个功能：</p>
<ul>
<li>改造libmodbus，增加“Write File Record”功能</li>
<li>测试：<!-- -->
<ul>
<li>H5开发板的UART2连接到UART4</li>
<li>任务1通过channel1（即UART2）发出“Write File Record”数据包</li>
<li>任务2通过channel2（即UART4）得到“Write File Record”数据包，验证无误后再LCD显示结果</li>
</ul>
</li>
</ul>
<p>按照下图连线：调试、供电、两个485互连：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image5.png" alt="img" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="923-uart驱动严重bug">9.2.3 UART驱动严重Bug<a href="#923-uart驱动严重bug" class="hash-link" aria-label="9.2.3 UART驱动严重Bug的直接链接" title="9.2.3 UART驱动严重Bug的直接链接">​</a></h3>
<p>本节源码为“3_程序源码\01_视频配套的源码\9-2-3_UART驱动严重Bug\h5_uart_dma_ok.7z”。</p>
<p>我们使用“HAL_UARTEx_ReceiveToIdle_DMA”来启动UART数据的接收，假设传入的数据长度是100。当数据接收完毕，或者发生了Idle中断时，“HAL_UARTEx_RxEventCallback”函数被调用。但是！除了这两种情况之外，当接收到一半数据时，这个函数也会被调用。</p>
<p>在以前的代码里，我们误认为“数据全部接收完毕”、“发生Idle中断”时，才会调用“HAL_UARTEx_RxEventCallback”。在里面，我们认为数据接收完毕，于是再次启动DMA传输。这会导致在接收到一半数据、触发“HAL_UARTEx_RxEventCallback”调用时，我们也再次启动DMA传输，导致数据丢失。</p>
<p>正确的“HAL_UARTEx_RxEventCallback”函数代码如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image6.png" alt="img" class="img_ev3q"></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">HAL_UARTEx_RxEventCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UART_HandleTypeDef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">huart</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">uint16_t</span><span class="token plain"> Size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PUART_Data pdata</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token class-name">uint16_t</span><span class="token plain"> old_pos</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">huart </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">huart2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pdata </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">g_uart2_data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">huart </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">huart4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pdata </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">g_uart4_data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* write queue : g_uart4_rx_buf Size bytes ==&gt; queue */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> old_pos</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> Size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">xQueueSendFromISR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pdata</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rxQueue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">pdata</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rx_buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    old_pos </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">huart</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">RxEventType </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> HAL_UART_RXEVENT_HT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        old_pos </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* re-start DMA+IDLE rx */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">HAL_UARTEx_ReceiveToIdle_DMA</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pdata</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">huart</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pdata</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">rx_buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UART_RX_BUF_LEN</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>当使用libmodbus时，有两个超时时间需要仔细考虑（Middlewares\Third_Party\libmodbus\modbus-private.h）：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image7.png" alt="img" class="img_ev3q"></p>
<p>“_RESPONSE_TIMEOUT”是“等待回应的时间”：client给server发出请求后，client要等待server发出的回应，这个等待时间要设置得比较大，以便server有足够的时间处理数据并发出回应。</p>
<p>“_BYTE_TIMEOUT”是“等待后续数据的时间”：一旦得到回应的第一个数据后，后续的数据应该是连续不断地来到，所以后续的超时时间可以设置得比较小(比如设置为modbus协议规定的3.5个字节时长)。但是，对于DMA传输要特殊考虑。</p>
<p>当使用DMA方式接收数据时，DMA可以及时地把串口接收到的数据存入内存，但是它无法及时通知应用程序：假设启动DMA传输来读取256字节(modbus rtu最大数据包)数据，当读取到一半数据即128字节的数据时才会触发“Half Transfer”的回调，这时才会通知应用程序。所以，使用libmosbus等待回应时，超时时间要设置得比较大，不仅要大于接收完128字节数据的时间，也要考虑：留更多的时间给对方，以便它有足够的时间处理数据然后回复。</p>
<p>当应用程序读取 到第一个回应的数据后，以后再读取后续数据时，超时时间如何设置？假设client等待回应后得到了一半的数据共128字节，它需要等待多久才可以得到第129个字节数据？DMA很快得到第129个数据，但是要等待剩余数据全部接收完毕，这时才会发生中断，应用程序才被通知到。得到回应之后（接收到一半的数据之后），DMA传输完成还需要一半数据的时间，以波特率115200为例，需要128x10/115200=11.1ms。所以，使用libmosbus传输比较大的回应数据时，xxx超时时间设置为10ms是不够的，为了保险，我们可以设置为20ms。</p>
<p>修改后的代码如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image8.png" alt="img" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="924-实现文件传输">9.2.4 实现文件传输<a href="#924-实现文件传输" class="hash-link" aria-label="9.2.4 实现文件传输的直接链接" title="9.2.4 实现文件传输的直接链接">​</a></h3>
<p>本节源码为“3_程序源码\01_视频配套的源码\9-2-4_实现文件传输\h5_write_file”。</p>
<p>对于“Write File Record”功能，它仅仅传输“一小块”数据，接收方无法从“这一小块”数据里知道“文件总大小”等信息。文件传输的功能需要我们自己实现：</p>
<ul>
<li>Client：使用文件名、文件大小，构造出Record Number为0的数据包，发送出去</li>
</ul>
<p>这个数据包的格式为：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">FileInfo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint32_t</span><span class="token plain"> version</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint32_t</span><span class="token plain"> file_len</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint32_t</span><span class="token plain"> load_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint32_t</span><span class="token plain"> crc32</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint8_t</span><span class="token plain"> file_name</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">FileInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PFileInfo</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Server：收到这个数据包后，就可以从中知道文件名、文件大小等信息</li>
<li>Client：就可以把文件内容拆分为多个Record，发送出去</li>
<li>Server：接收到数据包后，根据Record Number组装数据</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="93-读写任意传感器">9.3 读写任意传感器<a href="#93-读写任意传感器" class="hash-link" aria-label="9.3 读写任意传感器的直接链接" title="9.3 读写任意传感器的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="931-上机演示">9.3.1 上机演示<a href="#931-上机演示" class="hash-link" aria-label="9.3.1 上机演示的直接链接" title="9.3.1 上机演示的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-接线"><strong>1. 接线</strong><a href="#1-接线" class="hash-link" aria-label="1-接线的直接链接" title="1-接线的直接链接">​</a></h4>
<p>如下图连线，H5控制板使用USB线供电，中间的HUB也使用USB供电：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image9.png" alt="img" class="img_ev3q"></p>
<p>连接示意图为：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image10.png" alt="img" class="img_ev3q"></p>
<p><strong>注意</strong>：三个传感器的启动开关都拨到“ON”位置。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-烧写程序"><strong>2. 烧写程序</strong><a href="#2-烧写程序" class="hash-link" aria-label="2-烧写程序的直接链接" title="2-烧写程序的直接链接">​</a></h4>
<p>先烧写中控（H5开发板），工程为“3_程序源码\01_视频配套的源码\9-3-1_读写任意传感器上机演示\02_中控程序\h5_read_write_with_map.7z”。</p>
<p>再分别烧写三个传感器，工程为“3_程序源码\01_视频配套的源码\9-3-1_读写任意传感器上机演示\03_传感器程序\f030_demo.7z”。</p>
<p>注意：f030_demo需要分别设置下面的宏（这3个宏同一时间只能定义一个），编译出程序后分别烧写到3个传感器里。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_SWITCH_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_ENV_MONITOR_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_TMP_HUMI_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-使用"><strong>3. 使用</strong><a href="#3-使用" class="hash-link" aria-label="3-使用的直接链接" title="3-使用的直接链接">​</a></h4>
<p>先启动上位机：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image11.png" alt="img" class="img_ev3q"></p>
<p>再增加、设置“点”。</p>
<p>比如 要操作接在CH2上的温湿度传感器的蜂鸣器1，如下设置：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image12.png" alt="img" class="img_ev3q"></p>
<p>比如要操作中控（H5开发板自带的LED），如下设置：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image13.png" alt="img" class="img_ev3q"></p>
<p><strong>注意</strong>：</p>
<ul>
<li>在上位机里进行设置时，无法使用实体键盘（LVGL前台程序使用键盘有点难度），需要使用它弹出的虚拟键盘。</li>
<li>为了有空间显示虚拟键盘，当前要设置的“点”，会自动移到屏幕的最上面。</li>
</ul>
<p>最后就可以读写点了，比如：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image14.png" alt="img" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="932-使用点的映射表操作任意传感器的原理">9.3.2 使用“点”的映射表操作任意传感器的原理<a href="#932-使用点的映射表操作任意传感器的原理" class="hash-link" aria-label="9.3.2 使用“点”的映射表操作任意传感器的原理的直接链接" title="9.3.2 使用“点”的映射表操作任意传感器的原理的直接链接">​</a></h3>
<p>在《7.7.2 上位机访问多个传感器》曾经讲解过“点”的映射，它使用固定的映射表。本节课程将使用更加灵活的、随时可变的映射表。</p>
<p>上位机要读写传感器，需要中控进行转发。在上位机的角度，它只看到中控、只是读写中控的寄存器。中控需要“帮助”上位机去读写下挂的传感器。这里存在“点”的映射关系：上位机要读写的主控的“点”，怎么跟具体传感器的“点”对应。</p>
<p>使用“点”的映射信息，有3个问题要解决:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-怎么表示映射关系"><strong>1. 怎么表示映  射关系</strong><a href="#1-怎么表示映射关系" class="hash-link" aria-label="1-怎么表示映射关系的直接链接" title="1-怎么表示映射关系的直接链接">​</a></h4>
<p>使用如下结构体表示一个点的映射关系：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">PointMap</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> reg_type</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint16_t</span><span class="token plain"> reg_addr_master</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* 主控的寄存器地址 */</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint16_t</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">/* 0-主控本身, 1-通过CH1访问, 2-通过CH2访问 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint16_t</span><span class="token plain"> dev_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* 传感器的设备地址 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">uint16_t</span><span class="token plain"> reg_addr_salve</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* 传感器的寄存器地址 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">PointMap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PPointMap</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>主控根据这样的结构体，就知道：上位机想读写“reg_type”类型的“reg_addr_master”寄存器时，实际上是想读写“channel通道上、设备地址为dev_addr的reg_type类型的reg_addr_slave”寄存器。</p>
<p>上位机会把多个“PointMap”发给中控，中控要记录这些结构体。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-怎么发送映射关系"><strong>2 怎么发送映射关系</strong><a href="#2-怎么发送映射关系" class="hash-link" aria-label="2-怎么发送映射关系的直接链接" title="2-怎么发送映射关系的直接链接">​</a></h4>
<p>使用modbus_write_file发送file_no为0的数据。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-中控如何处理映射关系"><strong>3. 中控如何处理映射关系</strong><a href="#3-中控如何处理映射关系" class="hash-link" aria-label="3-中控如何处理映射关系的直接链接" title="3-中控如何处理映射关系的直接链接">​</a></h4>
<p>中控创建4个任务：</p>
<ul>
<li>USB串口任务：用于实现USB串口</li>
<li>LibmodbusServerTask：跟PC进行通信，接收上位机发来的“点”的映射表；根据上位机的读写请求操作DI/DO/AI/AO寄存器</li>
<li>CH0_Task：中控上有CH1、CH2，分别对应2个RS485接口。我们引入CH0，表示要读写中控板子自带的传感器（比如LED）。</li>
<li>CH0_Task有2个功能：<!-- -->
<ul>
<li>根据映射表，读取中控本身的传感器，更新DI/DO/AI/AO寄存器</li>
<li>当映射表里channel 0对应的DO/AO寄存器发生变化时，用来设置中控本身的传感器</li>
</ul>
</li>
<li>CH1_Task：它有2个功能<!-- -->
<ul>
<li>根据映射表，读取channel 1的传感器，更新DI/DO/AI/AO寄存器</li>
<li>当映射表里channel 1对应的DO/AO寄存器发生变化时，用 来设置对应的传感器</li>
</ul>
</li>
<li>CH2_Task：它有2个功能<!-- -->
<ul>
<li>根据映射表，读取channel 2的传感器，更新DI/DO/AI/AO寄存器</li>
<li>当映射表里channel 2对应的DO/AO寄存器发生变化时，用来设置对应的传感器</li>
</ul>
</li>
</ul>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image15.png" alt="img" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="933-中控代码讲解">9.3.3 中控代码讲解<a href="#933-中控代码讲解" class="hash-link" aria-label="9.3.3 中控代码讲解的直接链接" title="9.3.3 中控代码讲解的直接链接">​</a></h3>
<p>讲解“3_程序源码\01_视频配套的源码\9-3-1_读写任意传感器上机演示\02_中控程序\h5_read_write_with_map.7z”。</p>
<p>要讲解的代码，都在“Core\Src\control.c”里。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1libmodbusservertask任务"><strong>1.LibmodbusServerTask任务</strong><a href="#1libmodbusservertask任务" class="hash-link" aria-label="1libmodbusservertask任务的直接链接" title="1libmodbusservertask任务的直接链接">​</a></h4>
<p>它有2个功能：</p>
<ul>
<li>跟PC进行通信，接收上位机发来的“点”的映射表；</li>
<li>根据上位机的读写请求操作DI/DO/AI/AO寄存器</li>
</ul>
<p>代码如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image16.png" alt="img" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-ch0_task任务"><strong>2. CH0_Task任务</strong><a href="#2-ch0_task任务" class="hash-link" aria-label="2-ch0_task任务的直接链接" title="2-ch0_task任务的直接链接">​</a></h4>
<p>它有2个功能</p>
<ul>
<li>根据映射表，读取中控本身的传感器，更新DI/DO/AI/AO寄存器</li>
<li>当映射表里channel 0对应的DO/AO寄存器发生变化时，用来设置中控本身的传感器</li>
</ul>
<p>代码如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image17.png" alt="img" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-ch1_taskch2_task任务"><strong>3. CH1_Task、CH2_Task任务</strong><a href="#3-ch1_taskch2_task任务" class="hash-link" aria-label="3-ch1_taskch2_task任务的直接链接" title="3-ch1_taskch2_task任务的直接链接">​</a></h4>
<p>它们功能类似，都有2个功能</p>
<ul>
<li>根据映射表，读取channel 1或channel 2的传感器，更新DI/DO/AI/AO寄存器</li>
<li>当映射表里channel 1或channel 2对应的DO/AO寄存器发生变化时，用来设置对应的传感器</li>
</ul>
<p>代码如下（以CH1_Task为例）：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image18.png" alt="img" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-loop_once函数"><strong>3. loop_once函数</strong><a href="#3-loop_once函数" class="hash-link" aria-label="3-loop_once函数的直接链接" title="3-loop_once函数的直接链接">​</a></h4>
<p>它是CH0_Task、CH1_Task、CH2_Task的主要函数，代码如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image19.png" alt="img" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="94-iap升级">9.4 IAP升级<a href="#94-iap升级" class="hash-link" aria-label="9.4 IAP升级的直接链接" title="9.4 IAP升级的直接链接">​</a></h2>
<p>IAP是In Application Programming的首字母缩写，IAP是用户自己的程序在运行过程中对User Flash的部分区域进行烧写，目的是为了在产品发布后可以方便地通过预留的通信口对产品中的固件程序进行更新升级。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="941-上机演示">9.4.1 上机演示<a href="#941-上机演示" class="hash-link" aria-label="9.4.1 上机演示的直接链接" title="9.4.1 上机演示的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-接线-1"><strong>1. 接线</strong><a href="#1-接线-1" class="hash-link" aria-label="1-接线-1的直接链接" title="1-接线-1的直接链接">​</a></h4>
<p>如下图连线，H5控制板使用USB线供电，中间的HUB也使用USB供电：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image20.png" alt="img" class="img_ev3q"></p>
<p>连接示意图为：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image21.png" alt="img" class="img_ev3q"></p>
<p><strong>注意</strong>：三个传感器的启动开关都拨到“ON”位置。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-烧写h5-bootloader程序"><strong>2. 烧写H5 Bootloader程序</strong><a href="#2-烧写h5-bootloader程序" class="hash-link" aria-label="2-烧写h5-bootloader程序的直接链接" title="2-烧写h5-bootloader程序的直接链接">​</a></h4>
<p>先烧写中控（H5开发板），工程为“3_程序源码\01_视频配套的源码\9-4-1_IAP升级上机演示\02_中控程序\h5_iap.7z”。</p>
<p>注意：H5的BootLoader和APP是同一套代码，需要指定不同的ROM地址，如下设置即为Bootloader。</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image22.png" alt="img" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-烧写传感器bootloader程序"><strong>3. 烧写传感器Bootloader程序</strong><a href="#3-烧写传感器bootloader程序" class="hash-link" aria-label="3-烧写传感器bootloader程序的直接链接" title="3-烧写传感器bootloader程序的直接链接">​</a></h4>
<p>分别烧写三个传感器的Bootloader，工程为“3_程序源码\01_视频配套的源码\9-3-1_读写任意传感器上机演示\03_传感器程序\f030_iap.7z”。</p>
<p>注意：传感器的BootLoader和APP是同一套代码，需要指定不同的ROM地址。</p>
<p>先如下设置ROM地址：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image23.png" alt="img" class="img_ev3q"></p>
<p>注意：f030_iap需要分别设置下面的宏（这3个宏同一时间只能定义一个），编译出程序后分别烧写到3个传感器里。</p>
<p>再修改“f030_ipa\demo\Core\Src\freertos.c”，定义宏开关：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_SWITCH_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_ENV_MONITOR_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_TMP_HUMI_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>编译后，就可以分别烧录到对应的传感器。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-编译h5-app"><strong>4. 编译H5 APP</strong><a href="#4-编译h5-app" class="hash-link" aria-label="4-编译h5-app的直接链接" title="4-编译h5-app的直接链接">​</a></h4>
<p>可以使用如下目录有事先编译好的APP：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image24.png" alt="img" class="img_ev3q"></p>
<p>也可以自己编译。工程为“3_程序源码\01_视频配套的源码\9-4-1_IAP升级上机演示\02_中控程序\h5_iap.7z”。</p>
<p>注意：H5的BootLoader和APP是同一套代码，需要指定不同的ROM地址，如下设置即为APP。</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image25.png" alt="img" class="img_ev3q"></p>
<p>编译得到bin文件：demo_h5_app.bin。</p>
<p>最后，把bin文件放到上位机程序相同的目录下，这点很重要。由于LVGL的限制，目前只支持使用同目录下的文件。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-编译传感器-app"><strong>5. 编译传感器 APP</strong><a href="#5-编译传感器-app" class="hash-link" aria-label="5-编译传感器-app的直接链接" title="5-编译传感器-app的直接链接">​</a></h4>
<p>可以使用如下目录有事先编译好的APP：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image26.png" alt="img" class="img_ev3q"></p>
<p>也可以自己编译。工程为“3_程序源码\01_视频配套的源码\9-4-1_IAP升级上机演示\03_传感器程序\f030_iap.7z”。</p>
<p>注意：传感器的BootLoader和APP是同一套代码，需要指定不同的ROM地址。</p>
<p>先如下设置ROM地址：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image27.png" alt="img" class="img_ev3q"></p>
<p>注意：f030_iap需要分别设置下面的宏（这3个宏同一时间只能定义一个），编译出程序后分别烧写到3个传感器里。</p>
<p>再修改“f030_ipa\demo\Core\Src\freertos.c”，定义宏开关：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_SWITCH_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_ENV_MONITOR_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">USE_TMP_HUMI_SENSOR</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>编译后，就可以得到“demo_f030_app.bin”。对于不同的传感器，可以把bin文件分别改名为：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">demo_f030_app_ch1_dev1_switch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">demo_f030_app_ch1_dev2_env_monitor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">demo_f030_app_ch2_dev3_temp_humi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后，把bin文件放到上位机程序相同的目录下，这点很重要。由于LVGL的限制，目前只支持使用同目录下的文件。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="6-升级中控"><strong>6. 升级中控</strong><a href="#6-升级中控" class="hash-link" aria-label="6-升级中控的直接链接" title="6-升级中控的直接链接">​</a></h4>
<p>先启动上位机：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image28.png" alt="img" class="img_ev3q"></p>
<p>在界面上如下操作：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image29.png" alt="img" class="img_ev3q"></p>
<p>在上位机界面，可以看到升级进度：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image30.png" alt="img" class="img_ev3q"></p>
<p>在中控的LCD屏幕，在升级过程中显示“Bootloader”，升级完成后显示“Application”。</p>
<p>然后就可以按照《9.3.1 上机演示》使用中控了。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="7-升级传感器"><strong>7. 升级传感器</strong><a href="#7-升级传感器" class="hash-link" aria-label="7-升级传感器的直接链接" title="7-升级传感器的直接链接">​</a></h4>
<p>先启动上位机：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image31.png" alt="img" class="img_ev3q"></p>
<p>在界面上如下操作：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image32.png" alt="img" class="img_ev3q"></p>
<p>在上位机界面，可以看到升级进度：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image33.png" alt="img" class="img_ev3q"></p>
<p>在中控的LCD屏幕，在升级过程中显示“Send file to sensor: record_no =”类似的打印信息。</p>
<p>升级完成后，可以看到传感器的三个LED亮起。然后就可以按照《9.3.1 上机演示》使用传感器了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="942-iap升级的软件设计思路">9.4.2 IAP升级的软件设计思路<a href="#942-iap升级的软件设计思路" class="hash-link" aria-label="9.4.2 IAP升级的软件设计思路的直接链接" title="9.4.2 IAP升级的软件设计思路的直接链接">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-flash划分"><strong>1. Flash划分</strong><a href="#1-flash划分" class="hash-link" aria-label="1-flash划分的直接链接" title="1-flash划分的直接链接">​</a></h4>
<p>对于 中控，STM32H563RIV内置2MB Flash，划分如下：</p>
<ul>
<li>Bootloader占据256KB空间</li>
<li>APP占据1784KB空间</li>
<li>配置信息占据最后一个扇区8KB空间：用来保存APP版本、大小、校验码等信息。</li>
</ul>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image34.png" alt="img" class="img_ev3q"></p>
<p>对于传感器，STM32F030CC内置256KB Flash，划分如下：</p>
<ul>
<li>Bootloader占据128KB空间</li>
<li>APP占据126KB空间</li>
<li>配置信息占据最后一个扇区2KB空间：用来保存APP版本、大小、校验码等信息。</li>
</ul>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image35.png" alt="img" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-升级流程"><strong>2. 升级流程</strong><a href="#2-升级流程" class="hash-link" aria-label="2-升级流程的直接链接" title="2-升级流程的直接链接">​</a></h4>
<p>升级流程分为3个步骤：</p>
<ul>
<li>上位机让目标板进入Bootloader</li>
</ul>
<p>无论是中控还是传感器，它当前运行的程序可能是“Bootloader”或“APP”。要升级APP，必须让它进入Bootloader：</p>
<ul>
<li>对于中控：上位机直接发命令给中控让它进入Bootloader</li>
</ul>
<p>中控处于Bootloader的话则无需重启；中控处于APP的话，需要设置配置信息表明要进入Bootloader，然后软件复位；重启后运行的是Bootloader，它要根据配置信息保持在Bootloader。</p>
<ul>
<li>对于传感器：上位机直接发命令给中控，中控再转发给传感器让它进入Bootloader</li>
</ul>
<p>传感器处于Bootloader的话则无需重启；传感器处于APP的话，需要设置配置信息表明要进入Bootloader，然后软件复位；重启后运行的是Bootloader，它要根据配置信息保持在Bootloader。</p>
<p>注意：升级传感器时，中控要运行APP：它功能比Bootloader强大，可以更方便  地操作传感器。</p>
<p>所以：要升级中控，中控要运行Bootloader。要升级传感器，中控要运行APP，传感器要运行Bootloader。</p>
<ul>
<li>上位机发送固件、目标板接收到固件后烧录</li>
<li>上位机让目标板进入APP</li>
</ul>
<p>当上位机发送完固件后，再给中控或传感器发送“启动APP”的命令。目标板就要设置配置信息表明要进入APP，然后软件复位；重启后运行的是Bootloader，它要根据配置信息启动APP。</p>
<p>上位机程序流程图如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image36.png" alt="img" class="img_ev3q"></p>
<p>中控和传感器的Bootloader程序流程图如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image37.png" alt="img" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-点表增加命令寄存器"><strong>3. 点表：增加命令寄存器</strong><a href="#3-点表增加命令寄存器" class="hash-link" aria-label="3-点表增加命令寄存器的直接链接" title="3-点表增加命令寄存器的直接链接">​</a></h4>
<p>无论是中控还是传感器，都需要接收“启动Bootloader”、“启动APP”的命令。可以增加一个点：地址为0，类型为“AO”（4x）。</p>
<ul>
<li>写入0x55，表示“启动Bootloader”，即：让目标板进入Bootloader状态</li>
<li>写入0xAA，表示“启动APP”，即：让目标板进入APP状态</li>
</ul>
<p>最新点表如下：</p>
<ul>
<li>中控寄存器说明：</li>
</ul>
<table><thead><tr><th>设备地址</th><th>寄存器地址</th><th>寄存器类别</th><th>用途</th><th>描述</th></tr></thead><tbody><tr><td>01H</td><td>0000H</td><td>DI</td><td>控制LED1</td><td>1-亮</td></tr><tr><td>0000H</td><td>AO</td><td>升级命令寄存器</td><td>写入0x55：启动Bootloader写入0xAA：启动APP</td><td></td></tr></tbody></table>
<ul>
<li>开关量模块（SWITCH）寄存器说明：</li>
</ul>
<table><thead><tr><th>设备地址</th><th>寄存器地址</th><th>寄存器类别</th><th>用途</th><th>描述</th></tr></thead><tbody><tr><td>01H</td><td>0000H</td><td>DI</td><td>读取按键KEY1</td><td>1-被按下</td></tr><tr><td>0001H</td><td>DI</td><td>读取按键KEY2</td><td>1-被按下</td><td></td></tr><tr><td>0002H</td><td>DI</td><td>读取按键KEY3</td><td>1-被按下</td><td></td></tr><tr><td>0000H</td><td>DO</td><td>控制继电器1</td><td>1-吸合</td><td></td></tr><tr><td>0001H</td><td>DO</td><td>控制继电器2</td><td>1-吸合</td><td></td></tr><tr><td>0002H</td><td>DO</td><td>控制LED1</td><td>1-亮</td><td></td></tr><tr><td>0003H</td><td>DO</td><td>控制LED2</td><td>1-亮</td><td></td></tr><tr><td>0004H</td><td>DO</td><td>控制LED3</td><td>1-亮</td><td></td></tr><tr><td>0000H</td><td>AO</td><td>升级命令寄存器</td><td>写入0x55：启动Bootloader写入0xAA：启动APP</td><td></td></tr></tbody></table>
<ul>
<li>环境监测模块（ENV_MONITOR）寄存器说明：</li>
</ul>
<table><thead><tr><th>设备地址</th><th>寄存器地址</th><th>寄存器类别</th><th>用途</th><th>描述</th></tr></thead><tbody><tr><td>02H</td><td>0000H</td><td>DO</td><td>控制蜂鸣器1</td><td>1-响</td></tr><tr><td>0001H</td><td>DO</td><td>控制蜂鸣器2</td><td>1-响</td><td></td></tr><tr><td>0002H</td><td>DO</td><td>控制LED1</td><td>1-亮</td><td></td></tr><tr><td>0003H</td><td>DO</td><td>控制LED2</td><td>1-亮</td><td></td></tr><tr><td>0004H</td><td>DO</td><td>控制LED3</td><td>1-亮</td><td></td></tr><tr><td>0000H</td><td>AI</td><td>读取光敏电压</td><td>0xfff对应3.3V12位精度</td><td></td></tr><tr><td>0001H</td><td>AI</td><td>可调电阻器电压</td><td>0xfff对应3.3V12位精度</td><td></td></tr><tr><td>0000H</td><td>AO</td><td>升级命令寄存器</td><td>写入0x55：启动Bootloader写入0xAA：启动APP</td><td></td></tr></tbody></table>
<ul>
<li>温湿度模块（TEMP_HUMI）寄存器说明：</li>
</ul>
<table><thead><tr><th>设备地址</th><th>寄存器地址</th><th>寄存器类别</th><th>用途</th><th>描述</th></tr></thead><tbody><tr><td>03H</td><td>0000H</td><td>DO</td><td>控制蜂鸣器1</td><td>1-响</td></tr><tr><td>0001H</td><td>DO</td><td>控制蜂鸣器2</td><td>1-响</td><td></td></tr><tr><td>0002H</td><td>DO</td><td>控制LED1</td><td>1-亮</td><td></td></tr><tr><td>0003H</td><td>DO</td><td>控制LED2</td><td>1-亮</td><td></td></tr><tr><td>0004H</td><td>DO</td><td>控制LED3</td><td>1-亮</td><td></td></tr><tr><td>0000H</td><td>AI</td><td>读取温度</td><td>单位0.1摄氏度16位有符号整数</td><td></td></tr><tr><td>0001H</td><td>AI</td><td>读取湿度</td><td>单位0.1%RH16位有符合整数</td><td></td></tr><tr><td>0000H</td><td>AO</td><td>升级命令寄存器</td><td>写入0x55：启动Bootloader写入0xAA：启动APP</td><td></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-bootloader软件设计"><strong>4. Bootloader软件设计</strong><a href="#4-bootloader软件设计" class="hash-link" aria-label="4-bootloader软件设计的直接链接" title="4-bootloader软件设计的直接链接">​</a></h4>
<p>Bootloader升级APP的流程步骤看起来很多，其实它就做3件事：</p>
<ul>
<li>启动：</li>
</ul>
<p>根据配置信息，决定保留在Bootloader还是启动APP。</p>
<ul>
<li>处理启动命令：</li>
</ul>
<p>处理接收到“进入Bootloader”的命令、或“进入APP”的命令。</p>
<ul>
<li>处理文件块：</li>
</ul>
<p>中控的Bootloader需要处理映射信息、固件信息。传感器只会接收到固件信息，只需要处理固件信息。</p>
<p>处理映射信息：对于接收到的“Write File Record”数据包，如果record_no为0则解析出文件大小；如果record_no不为0则用来记录映射表。</p>
<p>处理固件信息：对于接收到的“Write File Record”数据包，如果record_no为0则解析出文件大小；如果record_no不为0则用来烧录Flash。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="5-iap要点及时序图"><strong>5. IAP要点及时序图</strong><a href="#5-iap要点及时序图" class="hash-link" aria-label="5-iap要点及时序图的直接链接" title="5-iap要点及时序图的直接链接">​</a></h4>
<p>要点有2个：</p>
<ul>
<li>在升级中控APP时：</li>
</ul>
<p>中控的Bootloader接收到文件块后，要马上烧录Flash，根据烧录结果再回复Modbus请求。这样，上位机每发出一个“Write File Record”，根据返回值就知道烧录是否成功，这样的程序结构简单。</p>
<ul>
<li>在升级传感器APP时：</li>
</ul>
<p>中控的APP接收到文件块后，要马上发给传感器，传感器的Bootloader接收到后，也要马上烧录Flash，根据烧录结果再回复Modbus请求给中控，中控再回复给上位机。这样，上位机每发出一个“Write File Record”，根据返回值就知道烧录是否成功，这样的程序结构简单。</p>
<p>对于上位机发来的启动命令，也是一样的：</p>
<ul>
<li>目标是中控的话，中控回复给上位机后要马上执行这些命令（先回复的原因是：执行重启命令的话，就无法回复了）。</li>
<li>目标是传感器的话，中控也要马上发送给传感器，确定传感器执行命令后，再回复给上位机。</li>
</ul>
<p>上位机升级中控程序时，时序图如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image38.png" alt="img" class="img_ev3q"></p>
<p>上位机升级传感器程序时，时序图如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image39.png" alt="img" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="943-中控bootloader代码讲解">9.4.3 中控Bootloader代码讲解<a href="#943-中控bootloader代码讲解" class="hash-link" aria-label="9.4.3 中控Bootloader代码讲解的直接链接" title="9.4.3 中控Bootloader代码讲解的直接链接">​</a></h3>
<p>中控代码为“3_程 序源码\01_视频配套的源码\9-4-1_IAP升级上机演示\02_中控程序\h5_iap.7z”</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-bootloader启动判断"><strong>1. Bootloader启动判断</strong><a href="#1-bootloader启动判断" class="hash-link" aria-label="1-bootloader启动判断的直接链接" title="1-bootloader启动判断的直接链接">​</a></h4>
<p>读取配置信息，决定是否启动APP：</p>
<ul>
<li>如果配置信息无效，则保持在Bootloader</li>
<li>如果配置信息明确表示要启动APP，则启动APP</li>
</ul>
<p>代码在“h5_iap\demo\Core\Src\main.c”，如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image40.png" alt="img" class="img_ev3q"></p>
<p>启动APP的关键在于：</p>
<ul>
<li>设置VTOR寄存器，重新指定异常向量表的位置为APP在Flash上的位置</li>
<li>读取APP异常向量表的第1个数据，把它写入SP寄存器</li>
<li>读取APP异常向量表的第2个数据，跳转执行</li>
<li>注释掉APP里设置VTOR的代码（它默认使用地址0），参考《8.2.3 编写APP》</li>
</ul>
<p>前3点代码在“h5_iap\demo\Core\Src\jump.S”，如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image41.png" alt="img" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-处理启动命令"><strong>2. 处理启动命令</strong><a href="#2-处理启动命令" class="hash-link" aria-label="2-处理启动命令的直接链接" title="2-处理启动命令的直接链接">​</a></h4>
<p>代码在“h5_iap\demo\Core\Src\control.c”，如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image42.png" alt="img" class="img_ev3q"></p>
<p>“process_emergency_cmd”函数在“h5_iap\demo\Core\Src\control.c”，代码如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image43.png" alt="img" class="img_ev3q"></p>
<p>怎么启动Bootloader呢？先写配置信息，再软件复位。代码在“h5_iap\demo\Core\Src\bootloader.c”：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image44.png" alt="img" class="img_ev3q"></p>
<p>怎么启动APP呢？先写配置信息，再软件复位。代码在“h5_iap\demo\Core\Src\bootloader.c”：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image45.png" alt="img" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-处理文件块write-file-record"><strong>3. 处理文件块（Write File Record）</strong><a href="#3-处理文件块write-file-record" class="hash-link" aria-label="3-处理文件块write-file-record的直接链接" title="3-处理文件块write-file-record的直接链接">​</a></h4>
<p>代码在“h5_iap\demo\Core\Src\control.c”，如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image46.png" alt="img" class="img_ev3q"></p>
<p>“process_file_record”函数在“h5_iap\demo\Core\Src\control.c”，代码如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image47.png" alt="img" class="img_ev3q"></p>
<p>对于“给主控烧写固件”，分为2步：</p>
<ul>
<li>得到record_no为0的文件头：记录文件大小、擦除Flash</li>
<li>得到record_no不为0的文件块：烧录Flash、最后写配置信息</li>
</ul>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image48.png" alt="img" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="944-传感器bootloader代码和中控app代码讲解">9.4.4 传感器Bootloader代码和中控APP代码讲解<a href="#944-传感器bootloader代码和中控app代码讲解" class="hash-link" aria-label="9.4.4 传感器Bootloader代码和中控APP代码讲解的直接链接" title="9.4.4 传感器Bootloader代码和中控APP代码讲解的直接链接">​</a></h3>
<p>Bootloader代码为“3_程序源码\01_视频配套的源码\9-3-1_读写任意传感器上机演示\03_传感器程序\f030_iap.7z”。</p>
<p>中控代码为“3_程序源码\01_视频配套的源码\9-4-1_IAP升级上机演示\02_中控程序\h5_iap.7z”</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-bootloader启动判断-1"><strong>1. Bootloader启动判断</strong><a href="#1-bootloader启动判断-1" class="hash-link" aria-label="1-bootloader启动判断-1的直接链接" title="1-bootloader启动判断-1的直接链接">​</a></h4>
<p>读取配置信息，决定是否启动APP：</p>
<ul>
<li>如果配置信息无效，则保持在Bootloader</li>
<li>如果配置信息明确表示要启动APP，则启动APP</li>
</ul>
<p>代码在“f030_iap\demo\Core\Src\main.c”，如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image49.png" alt="img" class="img_ev3q"></p>
<p>启动APP的关键在于：</p>
<p>① 重定位异常向量表：</p>
<p>STM32F030CC没有VTOR寄存器，无法通过修改它指定异常向量表，它的异常向量表永远在地址0。但是可以设置一个寄存器，地址0映射到Flash（0x08000000）或内存（0x20000000）。</p>
<p>运行Bootloader时，地址0默认就是映射到Flash（0x08000000），无需设置。</p>
<p>Bootloader启动APP时，要把地址0映射到内存（0x20000000），代码在“f030_iap\demo\Core\Src\jump.S”，如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image50.png" alt="img" class="img_ev3q"></p>
<p>② 读取APP异常向量表的第1个数据，把它写入SP寄存器
③ 读取APP异常向量表的第2个数据，跳转执行</p>
<p>第②③点代码在“f030_iap\demo\Core\Src\jump.S”，如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image51.png" alt="img" class="img_ev3q"></p>
<p>那么，传感器的程序就不要使用内存前面的区域，  如下设置：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image52.png" alt="img" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-处理启动命令-1"><strong>2. 处理启动命令</strong><a href="#2-处理启动命令-1" class="hash-link" aria-label="2-处理启动命令-1的直接链接" title="2-处理启动命令-1的直接链接">​</a></h4>
<p>代码在“f030_iap\demo\Core\Src\freertos.c”，如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image53.png" alt="img" class="img_ev3q"></p>
<p>“process_emergency_cmd”函数在“f030_iap\demo\Core\Src\control.c”，代码如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image54.png" alt="img" class="img_ev3q"></p>
<p>怎么启动Bootloader呢？先写配置信息，再软件复位。代码在“f030_iap\demo\Core\Src\bootloader.c”：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image55.png" alt="img" class="img_ev3q"></p>
<p>怎么启动APP呢？先写配置信息，再软件复位。代码在“f030_iap\demo\Core\Src\bootloader.c”：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image56.png" alt="img" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-处理文件块write-file-record-1"><strong>3. 处理文件块（Write File Record）</strong><a href="#3-处理文件块write-file-record-1" class="hash-link" aria-label="3-处理文件块write-file-record-1的直接链接" title="3-处理文件块write-file-record-1的直接链接">​</a></h4>
<p>代码在“f030_iap\demo\Core\Src\freertos.c”，如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image57.png" alt="img" class="img_ev3q"></p>
<p>“process_file_record”函数在“f030_iap_iap\demo\Core\Src\control.c”，代码如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image58.png" alt="img" class="img_ev3q"></p>
<p>对于烧写固件，分为2步：</p>
<ul>
<li>得到record_no为0的文件头：记录文件大小、擦除Flash</li>
<li>得到record_no不为0的文件块：烧录Flash、最后写配置信息</li>
</ul>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image59.png" alt="img" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-中控app要点"><strong>4. 中控APP要点</strong><a href="#4-中控app要点" class="hash-link" aria-label="4-中控app要点的直接链接" title="4-中控app要点的直接链接">​</a></h4>
<p>中控代码为“3_程序源码\01_视频配套的源码\9-4-1_IAP升级上机演示\02_中控程序\h5_iap.7z”。</p>
<p>升级传感器程序时，上位机发来的命令、文件，通过中控转发给传感器，传感器处理后，再回复中控，中控再回复给上位机。</p>
<p>整个流程非常长，需要尽快处理！要点有2个：</p>
<ul>
<li>中控接收到命令、“Write File Record”时，要马上处理，等待处理结果，返回给上位机</li>
<li>中控里其他读写传感器的任务，要暂时阻塞</li>
</ul>
<p>中控马上处理收到命令、“Write File Record”，代码在“h5_iap\demo\Core\Src\control.c”，而不是交给其他任务来处理（读写一般寄存器时，时让其他任务处理的）。如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image60.png" alt="img" class="img_ev3q"></p>
<p>怎么阻塞其他任务？代码在“h5_iap\demo\Core\Src\control.c”，如下：</p>
<p><img loading="lazy" src="http://photos.100ask.net/modbus-docs/project_one/chapter10/image61.png" alt="img" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/100askTeam/Modbus-TrainingDocs/tree/main/docs/Modbus-projectOne/chapter10.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/Modbus-projectOne/chapter9"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">第8章 程序升级</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/Modbus-projectOne/chapter11"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">第10章 调试心得</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#91-产品框架" class="table-of-contents__link toc-highlight">9.1 产品框架</a><ul><li><a href="#911-硬件框架" class="table-of-contents__link toc-highlight">9.1.1 硬件框架</a></li><li><a href="#912-设计思路" class="table-of-contents__link toc-highlight">9.1.2 设计思路</a></li><li><a href="#913-软件框架" class="table-of-contents__link toc-highlight">9.1.3 软件框架</a></li></ul></li><li><a href="#92-改造libmodbus实现文件传输" class="table-of-contents__link toc-highlight">9.2 改造libmodbus实现文件传输</a><ul><li><a href="#921-分析write-file-record功能" class="table-of-contents__link toc-highlight">9.2.1 分析Write File Record功能</a></li><li><a href="#922-实现write-file-record" class="table-of-contents__link toc-highlight">9.2.2 实现Write File Record</a></li><li><a href="#923-uart驱动严重bug" class="table-of-contents__link toc-highlight">9.2.3 UART驱动严重Bug</a></li><li><a href="#924-实现文件传输" class="table-of-contents__link toc-highlight">9.2.4 实现文件传输</a></li></ul></li><li><a href="#93-读写任意传感器" class="table-of-contents__link toc-highlight">9.3 读写任意传感器</a><ul><li><a href="#931-上机演示" class="table-of-contents__link toc-highlight">9.3.1 上机演示</a></li><li><a href="#932-使用点的映射表操作任意传感器的原理" class="table-of-contents__link toc-highlight">9.3.2 使用“点”的映射表操作任意传感器的原理</a></li><li><a href="#933-中控代码讲解" class="table-of-contents__link toc-highlight">9.3.3 中控代码讲解</a></li></ul></li><li><a href="#94-iap升级" class="table-of-contents__link toc-highlight">9.4 IAP升级</a><ul><li><a href="#941-上机演示" class="table-of-contents__link toc-highlight">9.4.1 上机演示</a></li><li><a href="#942-iap升级的软件设计思路" class="table-of-contents__link toc-highlight">9.4.2 IAP升级的软件设计思路</a></li><li><a href="#943-中控bootloader代码讲解" class="table-of-contents__link toc-highlight">9.4.3 中控Bootloader代码讲解</a></li><li><a href="#944-传感器bootloader代码和中控app代码讲解" class="table-of-contents__link toc-highlight">9.4.4 传感器Bootloader代码和中控APP代码讲解</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://dongshanpi.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">DongshanPI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://canaan-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Canaan-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://renesas-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Renesas-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://rtos.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RTOS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://tina.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">TinaSDK-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://allwinner-docs.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Allwinner-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://aw-r128.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">R128-Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://space.bilibili.com/275908810" target="_blank" rel="noopener noreferrer" class="footer__link-item">BiliBili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://forums.100ask.net" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://video.100ask.net/" target="_blank" rel="noopener noreferrer" class="footer__link-item">VideoCenter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/dongshanpi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weidongshan.coding.net/public/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Coding<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/100askTeam" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://gitee.com/weidongshan" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitee<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 100askTeam, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>